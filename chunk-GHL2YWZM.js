import{b as f}from"./chunk-YCEFGLUP.js";import{$b as h,Lb as l,O as c,S as a,e as o,gc as g,ha as i,i as u,m as d}from"./chunk-OUYPDPRE.js";import{d as s}from"./chunk-QEZ3K4DX.js";var p=class n{http=a(h);router=a(g);config=a(f);API_URL=this.config.apiBaseUrl;TOKEN_KEY=this.config.tokenKey;USER_KEY=this.config.userKey;loading=i(!1);userSubject=new o(this.getUserFromStorage());tokenSubject=new o(this.getTokenFromStorage());user$=this.userSubject.asObservable();token$=this.tokenSubject.asObservable();isAuthenticated$=this.user$.pipe(d(t=>!!t));_user=i(this.getUserFromStorage());_isAuthenticated=i(!!this.getUserFromStorage());user=l(()=>this._user());isAuthenticated=l(()=>this._isAuthenticated());get currentUser(){return this._user()}get loading$(){return u(this.loading())}getTokenFromStorage(){return typeof window<"u"?localStorage.getItem(this.TOKEN_KEY):null}getUserFromStorage(){if(typeof window<"u"){let t=localStorage.getItem(this.USER_KEY);return t?JSON.parse(t):null}return null}setAuthData(t,e){typeof window<"u"&&(localStorage.setItem(this.TOKEN_KEY,t),localStorage.setItem(this.USER_KEY,JSON.stringify(e))),this.tokenSubject.next(t),this.userSubject.next(e),this._user.set(e),this._isAuthenticated.set(!0)}clearAuthData(){typeof window<"u"&&(localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.USER_KEY)),this.tokenSubject.next(null),this.userSubject.next(null),this._user.set(null),this._isAuthenticated.set(!1)}getAuthToken(){return this.tokenSubject.value}getAuthHeaders(){let t=this.getAuthToken();return t?{Authorization:`Bearer ${t}`}:{}}signUp(t){return s(this,null,function*(){try{this.loading.set(!0);let e=yield this.http.post(`${this.API_URL}/auth/register`,t).toPromise();return e?.success&&e.data?(this.setAuthData(e.data.access_token,e.data.user),this.config.logIfEnabled("User registered successfully:",e.data.user.email),{data:e.data,error:null}):{data:null,error:new Error("Registration failed")}}catch(e){this.config.errorIfEnabled("SignUp error:",e);let r=e.error?.message||e.message||"Registration failed";return{data:null,error:new Error(r)}}finally{this.loading.set(!1)}})}signIn(t,e){return s(this,null,function*(){try{this.loading.set(!0);let r=yield this.http.post(`${this.API_URL}/auth/login`,{email:t,password:e}).toPromise();return r?.success&&r.data?(this.setAuthData(r.data.access_token,r.data.user),this.config.logIfEnabled("User signed in successfully:",r.data.user.email),{data:r.data,error:null}):{data:null,error:new Error("Login failed")}}catch(r){this.config.errorIfEnabled("SignIn error:",r);let y=r.error?.message||r.message||"Login failed";return{data:null,error:new Error(y)}}finally{this.loading.set(!1)}})}signOut(){return s(this,null,function*(){try{return this.loading.set(!0),this.clearAuthData(),this.config.logIfEnabled("User signed out successfully"),yield this.router.navigate(["/"]),{error:null}}catch(t){return this.config.errorIfEnabled("SignOut error:",t),{error:t}}finally{this.loading.set(!1)}})}updateProfile(t){return s(this,null,function*(){try{if(!this.currentUser)return{data:null,error:new Error("User not authenticated")};let e=yield this.http.put(`${this.API_URL}/users/${this.currentUser._id}`,t,{headers:this.getAuthHeaders()}).toPromise();return e?.success&&e.data?(this.userSubject.next(e.data),this._user.set(e.data),typeof window<"u"&&localStorage.setItem(this.USER_KEY,JSON.stringify(e.data)),this.config.logIfEnabled("Profile updated successfully"),{data:e.data,error:null}):{data:null,error:new Error("Failed to update profile")}}catch(e){return this.config.errorIfEnabled("Update profile error:",e),{data:null,error:e}}})}logout(){this.userSubject.next(null),this.tokenSubject.next(null),this._user.set(null),this._isAuthenticated.set(!1),typeof window<"u"&&(localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.USER_KEY)),this.config.logIfEnabled("User logged out successfully")}getUserById(t){return s(this,null,function*(){try{let e=yield this.http.get(`${this.API_URL}/users/${t}`,{headers:this.getAuthHeaders()}).toPromise();return e?.success&&e.data?e.data:null}catch(e){return this.config.errorIfEnabled("Get user by ID error:",e),null}})}switchMode(t){return s(this,null,function*(){try{this.loading.set(!0);let e=yield this.http.put(`${this.API_URL}/users/switch-mode`,{user_mode:t},{headers:this.getAuthHeaders()}).toPromise();return e?.success&&e.data?(this.userSubject.next(e.data),this._user.set(e.data),typeof window<"u"&&localStorage.setItem(this.USER_KEY,JSON.stringify(e.data)),this.config.logIfEnabled(`User mode switched to ${t} successfully`),{data:e.data,error:null}):{data:null,error:new Error("Failed to switch user mode")}}catch(e){return this.config.errorIfEnabled("Switch mode error:",e),{data:null,error:e}}finally{this.loading.set(!1)}})}static \u0275fac=function(e){return new(e||n)};static \u0275prov=c({token:n,factory:n.\u0275fac,providedIn:"root"})};export{p as a};
