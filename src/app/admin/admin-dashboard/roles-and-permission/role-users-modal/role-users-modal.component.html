<!-- Material Dialog Title -->
<div mat-dialog-title class="flex! items-center! justify-between! p-6! border-b! border-gray-200!">
  <div class="flex items-center space-x-4">
    <div class="relative">
      <div class="w-14 h-14 rounded-2xl flex items-center justify-center text-white shadow-lg"
           [style.background]="'linear-gradient(135deg, ' + (data.role.color || '#6366f1') + ', ' + (data.role.color || '#6366f1') + 'cc)'">
        <mat-icon class="text-2xl">{{ data.role.is_system_role ? 'security' : 'admin_panel_settings' }}</mat-icon>
      </div>
      <div *ngIf="data.role.is_system_role" 
           class="absolute -top-1 -right-1 w-6 h-6 bg-amber-400 rounded-full flex items-center justify-center">
        <mat-icon class="text-xs text-white">star</mat-icon>
      </div>
    </div>
    
    <div>
      <h2 class="text-2xl font-bold text-gray-900 mb-1">{{ data.role.display_name || data.role.name }}</h2>
      <div class="flex items-center space-x-4 text-sm text-gray-600">
        <span class="flex items-center">
          <mat-icon class="w-4 h-4 mr-1">people</mat-icon>
          {{ roleUsers().length }} users assigned
        </span>
        <span class="flex items-center">
          <mat-icon class="w-4 h-4 mr-1">security</mat-icon>
          {{ getPermissionCount() }} permissions
        </span>
      </div>
    </div>
  </div>
  
  <button mat-icon-button mat-dialog-close class="text-gray-400 hover:text-gray-600">
    <mat-icon>close</mat-icon>
  </button>
</div>

<!-- Material Dialog Content -->
<mat-dialog-content class="p-0 max-h-[70vh] overflow-y-auto">
  <!-- Add User Section -->
  <div class="p-6 bg-gradient-to-r from-blue-50 via-indigo-50 to-purple-50 border-b border-gray-100">
    <div class="max-w-4xl mx-auto">
      <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center space-x-3 mb-6">
          <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center">
            <mat-icon class="text-white">person_add</mat-icon>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-gray-900">Add User to Role</h3>
            <p class="text-sm text-gray-600">Assign a new user to this role with optional settings</p>
          </div>
        </div>

        <form [formGroup]="assignForm" (ngSubmit)="assignUserToRole()" class="space-y-6">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- User Selection with Autocomplete -->
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Search and Select User</mat-label>
              <input matInput 
                     [formControl]="userSearchControl"
                     [matAutocomplete]="userAutocomplete"
                     placeholder="Type to search users..."
                     [disabled]="isLoadingUsers">
              <mat-autocomplete #userAutocomplete="matAutocomplete" 
                                [displayWith]="displayUser"
                                (optionSelected)="onUserSelected($event)">
                <mat-option *ngIf="isLoadingUsers" disabled>
                  <div class="flex items-center space-x-2 py-2">
                    <mat-icon class="animate-spin w-4 h-4">hourglass_empty</mat-icon>
                    <span>Loading users...</span>
                  </div>
                </mat-option>
                <mat-option *ngIf="!isLoadingUsers && filteredUsers().length === 0 && userSearchControl.value && userSearchControl.value.length >= 2" disabled>
                  <div class="flex items-center space-x-2 py-2 text-gray-500">
                    <mat-icon class="w-4 h-4">search_off</mat-icon>
                    <span>No users found for "{{ userSearchControl.value }}"</span>
                  </div>
                </mat-option>
                <mat-option *ngIf="!isLoadingUsers && filteredUsers().length === 0 && (!userSearchControl.value || userSearchControl.value.length < 2)" disabled>
                  <div class="flex items-center space-x-2 py-2 text-gray-500">
                    <mat-icon class="w-4 h-4">search</mat-icon>
                    <span>Type at least 2 characters to search</span>
                  </div>
                </mat-option>
                <mat-option *ngFor="let user of filteredUsers()" [value]="user">
                  <div class="flex items-center space-x-3 py-2">
                    <div class="w-8 h-8 bg-gradient-to-r from-purple-400 to-pink-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                      {{ getUserInitials(user) }}
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="font-medium text-gray-900">{{ getUserDisplayName(user) }}</div>
                      <div class="text-sm text-gray-500 truncate">{{ user.email }}</div>
                      <div class="text-xs text-gray-400">{{ user.username }}</div>
                    </div>
                    <div class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full">
                      Available
                    </div>
                  </div>
                </mat-option>
              </mat-autocomplete>
              <mat-error *ngIf="assignForm.get('user_id')?.hasError('required')">
                Please select a user to assign to this role
              </mat-error>
              <mat-hint *ngIf="isLoadingUsers">Searching users...</mat-hint>
              <mat-hint *ngIf="!isLoadingUsers && filteredUsers().length > 0">{{ filteredUsers().length }} available user{{ filteredUsers().length === 1 ? '' : 's' }}</mat-hint>
              <mat-hint *ngIf="!isLoadingUsers && filteredUsers().length === 0 && userSearchControl.value && userSearchControl.value.length >= 2">No users found for "{{ userSearchControl.value }}"</mat-hint>
              <mat-hint *ngIf="!isLoadingUsers && filteredUsers().length === 0 && (!userSearchControl.value || userSearchControl.value.length < 2)">Type at least 2 characters to search for users</mat-hint>
            </mat-form-field>

            <!-- Expiry Date -->
            <mat-form-field appearance="outline" class="w-full date-picker-field">
              <mat-label>Expiry Date (Optional)</mat-label>
              <input matInput 
                     [matDatepicker]="picker" 
                     formControlName="expires_at" 
                     [min]="minDate"
                     placeholder="Click to select date"
                     (click)="openDatePicker(picker)"
                     (focus)="openDatePicker(picker)"
                     readonly>
              <mat-datepicker-toggle matIconSuffix 
                                   [for]="picker"
                                   (click)="openDatePicker(picker)"></mat-datepicker-toggle>
              <mat-datepicker #picker startView="month"></mat-datepicker>
              <mat-error *ngIf="assignForm.get('expires_at')?.hasError('pastDate')">
                {{ assignForm.get('expires_at')?.errors?.['pastDate']?.message }}
              </mat-error>
              <mat-hint>Leave empty for permanent assignment (cannot select past dates)</mat-hint>
            </mat-form-field>
          </div>

          <!-- Notes -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Assignment Notes (Optional)</mat-label>
            <textarea matInput formControlName="notes" rows="3" 
                     placeholder="Add any notes about this role assignment..."></textarea>
            <mat-hint>Optional notes about why this user is being assigned this role</mat-hint>
          </mat-form-field>

          <!-- Submit Button -->
          <div class="flex justify-end">
            <button mat-raised-button type="submit" 
                    class="px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold rounded-xl shadow-lg transform transition-all duration-200 hover:scale-105"
                    [disabled]="assignForm.invalid || isAssigning || isLoadingUsers">
              <div class="flex items-center space-x-2">
                <mat-icon *ngIf="isAssigning" class="animate-spin">hourglass_empty</mat-icon>
                <mat-icon *ngIf="!isAssigning">person_add</mat-icon>
                <span>{{ isAssigning ? 'Assigning User...' : 'Assign User to Role' }}</span>
              </div>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Assigned Users Section -->
  <div class="p-6">
    <div class="max-w-4xl mx-auto">
      <!-- Section Header -->
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-600 rounded-xl flex items-center justify-center">
            <mat-icon class="text-white">group</mat-icon>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-gray-900">Assigned Users</h3>
            <p class="text-sm text-gray-600">Users currently assigned to this role</p>
          </div>
        </div>
        
        <button mat-stroked-button (click)="loadRoleUsers()" [disabled]="isLoading"
                class="flex items-center space-x-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
          <mat-icon class="w-4 h-4" [class.animate-spin]="isLoading">refresh</mat-icon>
          <span>Refresh</span>
        </button>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoading" class="flex flex-col items-center justify-center py-12 space-y-4">
        <mat-progress-spinner diameter="48" class="text-blue-600"></mat-progress-spinner>
        <p class="text-gray-600 font-medium">Loading assigned users...</p>
      </div>

      <!-- Empty State -->
      <div *ngIf="!isLoading && roleUsers().length === 0" 
           class="text-center py-16 bg-gray-50 rounded-2xl border-2 border-dashed border-gray-300">
        <div class="w-16 h-16 mx-auto bg-gray-200 rounded-full flex items-center justify-center mb-4">
          <mat-icon class="text-3xl text-gray-400">group_off</mat-icon>
        </div>
        <h4 class="text-lg font-semibold text-gray-900 mb-2">No users assigned</h4>
        <p class="text-gray-600 mb-4">This role hasn't been assigned to any users yet.</p>
        <p class="text-sm text-gray-500">Use the form above to assign your first user to this role.</p>
      </div>

      <!-- Users Grid -->
      <div *ngIf="!isLoading && roleUsers().length > 0" class="grid gap-4">
        <div *ngFor="let userRole of roleUsers(); trackBy: trackByUserRole" 
             class="bg-white rounded-2xl border border-gray-200 p-6 hover:shadow-lg transition-all duration-200 hover:border-gray-300">
          <div class="flex items-center justify-between">
            <!-- User Profile -->
            <div class="flex items-center space-x-4">
              <div class="relative">
                <div class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold text-lg">
                  {{ getUserInitials(getUser(userRole)) }}
                </div>
                <div class="absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-white"
                     [class]="getStatusClass(userRole) === 'active' ? 'bg-green-500' : 
                             getStatusClass(userRole) === 'expiring' ? 'bg-yellow-500' : 'bg-red-500'">
                </div>
              </div>
              
              <div class="flex-1 min-w-0">
                <h4 class="text-lg font-semibold text-gray-900">{{ getUserDisplayName(getUser(userRole)) }}</h4>
                <p class="text-sm text-gray-600 mb-2">{{ getUser(userRole)?.email }}</p>
                
                <div class="flex items-center space-x-4 text-xs text-gray-500">
                  <span class="flex items-center">
                    <mat-icon class="w-3 h-3 mr-1">schedule</mat-icon>
                    Assigned {{ formatDate(userRole.assigned_at || userRole.createdAt) }}
                  </span>
                  <span *ngIf="userRole.expires_at" class="flex items-center"
                        [class.text-orange-600]="isExpiringSoon(userRole)">
                    <mat-icon class="w-3 h-3 mr-1">event</mat-icon>
                    Expires {{ formatDate(userRole.expires_at) }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Status & Actions -->
            <div class="flex items-center space-x-3">
              <!-- Status Badges -->
              <div class="flex items-center space-x-2">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium"
                      [class]="getStatusClass(userRole) === 'active' ? 'bg-green-100 text-green-700 border border-green-200' : 
                               getStatusClass(userRole) === 'expiring' ? 'bg-orange-100 text-orange-700 border border-orange-200' :
                               getStatusClass(userRole) === 'expired' ? 'bg-red-100 text-red-700 border border-red-200' :
                               'bg-gray-100 text-gray-700 border border-gray-200'">
                  <div class="w-1.5 h-1.5 rounded-full mr-1.5"
                       [class]="getStatusClass(userRole) === 'active' ? 'bg-green-500' : 
                               getStatusClass(userRole) === 'expiring' ? 'bg-orange-500' :
                               getStatusClass(userRole) === 'expired' ? 'bg-red-500' : 'bg-gray-500'">
                  </div>
                  {{ getStatusText(userRole) }}
                </span>
                
                <span *ngIf="userRole.notes" 
                      class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700 cursor-help"
                      matTooltip="{{ userRole.notes }}">
                  <mat-icon class="w-3 h-3">note</mat-icon>
                </span>
              </div>

              <!-- Action Buttons -->
              <div class="flex items-center space-x-1">
                <button mat-icon-button 
                        *ngIf="userRole.expires_at && isExpiringSoon(userRole)"
                        (click)="extendExpiry(userRole)"
                        matTooltip="Extend Expiry"
                        class="text-orange-600 hover:bg-orange-50">
                  <mat-icon class="w-5 h-5">schedule</mat-icon>
                </button>
                
                <button mat-icon-button 
                        (click)="removeUserFromRole(userRole)"
                        matTooltip="Remove User from Role"
                        class="text-red-600 hover:bg-red-50">
                  <mat-icon class="w-5 h-5">person_remove</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</mat-dialog-content>

<!-- Material Dialog Actions -->
<mat-dialog-actions class="flex justify-end p-6 border-t border-gray-200 bg-gray-50">
  <button mat-stroked-button mat-dialog-close 
          class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-white transition-colors">
    Close
  </button>
</mat-dialog-actions>