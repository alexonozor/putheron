<div class="h-full bg-gray-50 flex flex-col">
  <!-- Header Section -->
  <div class="bg-white border-b border-gray-200 px-6 py-6 flex-shrink-0">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Business Management</h1>
        <p class="text-gray-600 mt-1">Manage all businesses in the platform</p>
      </div>
      <button 
        mat-raised-button 
        color="primary" 
        (click)="loadBusinesses()"
        [disabled]="loading()">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
    </div>
  </div>

  <!-- Filters and Search Section -->
  <div class="bg-white border-b border-gray-200 px-6 py-4 flex-shrink-0">
    <div class="flex flex-col lg:flex-row gap-4">
      <!-- Search -->
      <mat-form-field appearance="outline" class="flex-1">
        <mat-label>Search businesses</mat-label>
        <input 
          matInput 
          placeholder="Search by name, city, state, or email"
          [value]="searchQuery()"
          (input)="onSearchChange($any($event.target).value || '')">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <!-- Status Filter -->
      <mat-form-field appearance="outline" class="min-w-48">
        <mat-label>Status</mat-label>
        <mat-select 
          [value]="statusFilter()"
          (selectionChange)="onStatusFilterChange($event.value)">
          @for (status of statusOptions; track status.value) {
            <mat-option [value]="status.value">{{ status.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <!-- Featured Filter -->
      <mat-form-field appearance="outline" class="min-w-48">
        <mat-label>Featured</mat-label>
        <mat-select 
          [value]="featuredFilter()"
          (selectionChange)="onFeaturedFilterChange($event.value)">
          @for (featured of featuredOptions; track featured.value) {
            <mat-option [value]="featured.value">{{ featured.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>
  </div>

  <!-- Bulk Actions Toolbar -->
  @if (selectedBusinesses().size > 0) {
    <div class="bg-blue-50 border-b border-blue-200 px-6 py-3 flex-shrink-0">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <span class="text-sm font-medium text-blue-900">
            {{ selectedBusinesses().size }} business(es) selected
          </span>
          <mat-chip-set>
            <mat-chip (click)="clearSelection()">
              <mat-icon matChipRemove>cancel</mat-icon>
              Clear selection
            </mat-chip>
          </mat-chip-set>
        </div>
        <div class="flex items-center space-x-2">
          <button 
            mat-stroked-button 
            color="primary"
            (click)="bulkVerifyBusinesses()">
            <mat-icon>verified</mat-icon>
            Verify Selected
          </button>
          <button 
            mat-stroked-button 
            color="accent"
            (click)="bulkToggleFeatured(true)">
            <mat-icon>star</mat-icon>
            Feature Selected
          </button>
          <button 
            mat-stroked-button 
            color="warn"
            (click)="bulkDeleteBusinesses()">
            <mat-icon>delete</mat-icon>
            Delete Selected
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Main Content Area - Flexible to fill remaining space -->
  <div class="flex-1 bg-white overflow-hidden">
    <!-- Loading State -->
    @if (loading()) {
      <mat-card class="h-full flex items-center justify-center">
        <mat-spinner></mat-spinner>
      </mat-card>
    } @else {
      <!-- Main Table Card -->
      <mat-card class="h-full flex !bg-white flex-col">
        <div class="flex-1 overflow-auto">
          <table mat-table [dataSource]="filteredBusinesses()" class="w-full !bg-white">
            
            <!-- Select Column -->
            <ng-container matColumnDef="select">
              <th mat-header-cell *matHeaderCellDef class="w-12">
                <mat-checkbox
                  [checked]="isAllSelected()"
                  [indeterminate]="isIndeterminate()"
                  (change)="toggleAllSelection()">
                </mat-checkbox>
              </th>
              <td mat-cell *matCellDef="let business" class="w-12">
                <mat-checkbox
                  [checked]="isBusinessSelected(business._id)"
                  (change)="toggleBusinessSelection(business._id)">
                </mat-checkbox>
              </td>
            </ng-container>

            <!-- Name Column -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef class="font-semibold text-gray-900">Business Name</th>
              <td mat-cell *matCellDef="let business" class="py-6">
                <div class="flex items-center space-x-4">
                  @if (business.logo_url) {
                    <img [src]="business.logo_url" [alt]="business.name" class="w-12 h-12 rounded-lg object-cover border border-gray-200">
                  } @else {
                    <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center border border-gray-200">
                      <mat-icon class="text-gray-400">business</mat-icon>
                    </div>
                  }
                  <div>
                    <div class="font-medium text-gray-900 text-sm">{{ business.name }}</div>
                    <div class="text-sm text-gray-500">{{ business.city }}, {{ business.state }}</div>
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Owner Column -->
            <ng-container matColumnDef="owner">
              <th mat-header-cell *matHeaderCellDef class="font-semibold text-gray-900">Owner</th>
              <td mat-cell *matCellDef="let business" class="py-6">
                <div class="text-sm">
                  <div class="font-medium text-gray-900">{{ getOwnerName(business.owner_id) }}</div>
                  <div class="text-gray-500">{{ business.contact_email || 'No email' }}</div>
                </div>
              </td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef class="font-semibold text-gray-900">Status</th>
              <td mat-cell *matCellDef="let business" class="py-6">
                <div class="flex flex-col space-y-2">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium w-fit"
                        [ngClass]="{
                          'bg-green-100 text-green-800': business.status === 'approved',
                          'bg-yellow-100 text-yellow-800': business.status === 'pending',
                          'bg-red-100 text-red-800': business.status === 'rejected'
                        }">
                    {{ business.status | titlecase }}
                  </span>
                  @if (business.is_featured) {
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 w-fit">
                      <mat-icon class="w-3 h-3 mr-1 !text-xs">star</mat-icon>
                      Featured
                    </span>
                  }
                </div>
              </td>
            </ng-container>

            <!-- Rating Column -->
            <ng-container matColumnDef="rating">
              <th mat-header-cell *matHeaderCellDef class="font-semibold text-gray-900">Rating</th>
              <td mat-cell *matCellDef="let business" class="py-6">
                <div class="text-sm">
                  <div class="flex items-center">
                    <mat-icon class="text-yellow-400 text-base mr-1">star</mat-icon>
                    <span class="font-medium text-gray-900">{{ business.rating || 0 }}</span>
                  </div>
                  <div class="text-gray-500">{{ business.review_count || 0 }} reviews</div>
                </div>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef class="font-semibold text-gray-900">Actions</th>
              <td mat-cell *matCellDef="let business" class="py-6">
                <button 
                  mat-icon-button 
                  [matMenuTriggerFor]="actionsMenu"
                  matTooltip="More actions">
                  <mat-icon>more_vert</mat-icon>
                </button>
                
                <mat-menu #actionsMenu="matMenu">
                  <button mat-menu-item (click)="viewBusinessDetails(business._id)">
                    <mat-icon>visibility</mat-icon>
                    <span>View Details</span>
                  </button>
                  
                  <mat-divider></mat-divider>
                  
                  <button mat-menu-item (click)="toggleFeatured(business)">
                    <mat-icon>{{ business.is_featured ? 'star_border' : 'star' }}</mat-icon>
                    <span>{{ business.is_featured ? 'Remove from Featured' : 'Add to Featured' }}</span>
                  </button>
                  
                  @if (business.status === 'pending') {
                    <button mat-menu-item (click)="verifyBusiness(business)">
                      <mat-icon color="primary">verified</mat-icon>
                      <span>Verify Business</span>
                    </button>
                  }
                  
                  <mat-divider></mat-divider>
                  
                  <button mat-menu-item (click)="deleteBusiness(business)" class="text-red-600">
                    <mat-icon color="warn">delete</mat-icon>
                    <span>Delete Business</span>
                  </button>
                </mat-menu>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns" class="bg-gray-50"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
                class="hover:bg-gray-50 border-b border-gray-100 transition-colors"></tr>
          </table>
        </div>
        
        @if (filteredBusinesses().length === 0 && !loading()) {
          <div class="text-center py-16">
            @if (businesses().length === 0) {
              <mat-icon class="text-gray-400 text-6xl mb-4">business</mat-icon>
              <h3 class="text-lg font-medium text-gray-900 mb-2">No businesses found</h3>
              <p class="text-gray-500">There are no businesses to display at the moment.</p>
            } @else {
              <mat-icon class="text-gray-400 text-6xl mb-4">search_off</mat-icon>
              <h3 class="text-lg font-medium text-gray-900 mb-2">No results found</h3>
              <p class="text-gray-500">Try adjusting your search or filter criteria.</p>
              <button 
                mat-stroked-button 
                color="primary" 
                class="mt-4"
                (click)="searchQuery.set(''); statusFilter.set('all'); featuredFilter.set('all'); setupFilters()">
                Clear all filters
              </button>
            }
          </div>
        }
      </mat-card>
    }
  </div>
</div>
