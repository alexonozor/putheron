<div class="min-h-screen bg-gray-50">
  @if (loading()) {
    <div class="flex justify-center items-center py-20">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>
  } @else if (error()) {
    <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <div class="text-center py-12 bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="text-red-400 mb-4">
          <mat-icon class="text-6xl">error_outline</mat-icon>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">{{ error() }}</h3>
        <div class="space-x-4">
          <button 
            (click)="goBack()"
            class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
            Go Back
          </button>
          <button 
            (click)="loadData()"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
            Try Again
          </button>
        </div>
      </div>
    </div>
  } @else {
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Header -->
      <div class="mb-8">
        <button 
          (click)="goBack()"
          class="mb-4 flex items-center text-gray-600 hover:text-gray-800 transition-colors">
          <mat-icon class="mr-2">arrow_back</mat-icon>
          Back to Dashboard
        </button>
        
        <div class="text-center">
          <h1 class="text-3xl font-bold text-gray-900 mb-2">
            {{ isEditMode() ? 'Edit Your Business' : 'Create Your Business' }}
          </h1>
          <p class="text-gray-600">
            {{ isEditMode() ? 'Update your business profile and information' : 'Set up your business profile and start connecting with customers' }}
          </p>
        </div>
      </div>

      <!-- Business Creation Form -->
      <mat-card class="w-full">
        <!-- <mat-card-content class="p-6"> -->
          <mat-stepper #stepper [linear]="true" [orientation]="isMobile() ? 'vertical' : 'horizontal'" class="business-stepper">
          <!-- Step 1: Business Information -->
          <mat-step [stepControl]="businessInfoForm" label="Business Information">
            <form [formGroup]="businessInfoForm" class="p-6 space-y-6">
              <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                  Tell us about your business
                </h3>
                <p class="text-gray-600 mb-6">
                  Provide basic information about your business to get started.
                </p>
              </div>

              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Business Name</mat-label>
                <input 
                  matInput 
                  formControlName="name" 
                  placeholder="Enter your business name"
                  required>
                @if (businessInfoForm.get('name')?.hasError('required') && businessInfoForm.get('name')?.touched) {
                  <mat-error>Business name is required</mat-error>
                }
                @if (businessInfoForm.get('name')?.hasError('minlength') && businessInfoForm.get('name')?.touched) {
                  <mat-error>Business name must be at least 2 characters</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Business Description</mat-label>
                <textarea 
                  matInput 
                  formControlName="description"
                  rows="4"
                  placeholder="Describe what your business does, your services, and what makes you unique..."
                  required></textarea>
                @if (businessInfoForm.get('description')?.hasError('required') && businessInfoForm.get('description')?.touched) {
                  <mat-error>Business description is required</mat-error>
                }
                @if (businessInfoForm.get('description')?.hasError('minlength') && businessInfoForm.get('description')?.touched) {
                  <mat-error>Description must be at least 10 characters</mat-error>
                }
              </mat-form-field>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <mat-form-field appearance="outline">
                  <mat-label>Business Type</mat-label>
                  <mat-select formControlName="business_type" required>
                    <mat-option value="service">Service Business</mat-option>
                    <mat-option value="product">Product Business</mat-option>
                    <mat-option value="both">Both Service & Product</mat-option>
                  </mat-select>
                  @if (businessInfoForm.get('business_type')?.hasError('required') && businessInfoForm.get('business_type')?.touched) {
                    <mat-error>Please select a business type</mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Category</mat-label>
                  <mat-select 
                    formControlName="category_id" 
                    (selectionChange)="onCategoryChange($event.value)"
                    required>
                    @for (category of categories(); track category._id) {
                      <mat-option [value]="category._id">
                        {{ category.name }}
                      </mat-option>
                    }
                  </mat-select>
                  @if (businessInfoForm.get('category_id')?.hasError('required') && businessInfoForm.get('category_id')?.touched) {
                    <mat-error>Please select a category</mat-error>
                  }
                </mat-form-field>
              </div>

              @if (subcategories().length > 0) {
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Subcategory (Optional)</mat-label>
                  <mat-select formControlName="subcategory_id">
                    <mat-option value="">None</mat-option>
                    @for (subcategory of subcategories(); track subcategory._id) {
                      <mat-option [value]="subcategory._id">
                        {{ subcategory.name }}
                      </mat-option>
                    }
                  </mat-select>
                </mat-form-field>
              }

              <div class="flex flex-col md:flex-row justify-end gap-4 items-start md:items-center">
                @if (!isBusinessInfoValid()) {
                  <div class="text-sm text-amber-600 flex items-center order-2 md:order-1">
                    <mat-icon class="text-sm mr-1">info</mat-icon>
                    Please fill in all required fields to continue
                  </div>
                }
                <button 
                  type="button"
                  (click)="nextStep(stepper)"
                  [disabled]="!isBusinessInfoValid()"
                  mat-raised-button
                  color="primary"
                  class="flex items-center order-1 md:order-2 w-full md:w-auto">
                  Next
                  <mat-icon class="ml-2">arrow_forward</mat-icon>
                </button>
              </div>
            </form>
          </mat-step>

          <!-- Step 2: Business Details -->
          <mat-step [stepControl]="businessDetailsForm" label="Contact & Location">
            <form [formGroup]="businessDetailsForm" class="p-6 space-y-6" autocomplete="off">
              <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                  Contact Information & Location
                </h3>
                <p class="text-gray-600 mb-6">
                  Help customers find and contact your business.
                </p>
              </div>

              <!-- Location Fields -->
              <div>
                <h4 class="text-md font-medium text-gray-900 mb-3">Business Location</h4>
                <div class="space-y-4">
                  <mat-form-field appearance="outline" class="w-full">
                    <mat-label>Search Address</mat-label>
                    <input 
                      matInput 
                      #addressInput
                      formControlName="address"
                      autocomplete="off" 
                      placeholder="Start typing your business address...">
                    <mat-icon matSuffix>location_on</mat-icon>
                    <mat-icon matPrefix>search</mat-icon>
                    <mat-hint>Start typing to search for your business address (USA only)</mat-hint>
                  </mat-form-field>

                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-800">
                    <div class="flex items-start">
                      <mat-icon class="text-blue-600 mr-2 mt-0.5 text-base">info</mat-icon>
                      <div>
                        <strong>Auto-complete tip:</strong> Type your complete business address above. City, state, and postal code will be automatically filled and locked. Use "Edit" to manually modify or "Clear" to start over.
                      </div>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <mat-form-field appearance="outline" [class.opacity-75]="businessDetailsForm.get('city')?.disabled">
                      <mat-label>City</mat-label>
                      <input 
                        matInput 
                        formControlName="city" 
                        placeholder="Enter city"
                        required>
                      @if (businessDetailsForm.get('city')?.disabled) {
                        <mat-icon matSuffix class="text-gray-400">lock</mat-icon>
                      }
                      @if (businessDetailsForm.get('city')?.hasError('required') && businessDetailsForm.get('city')?.touched) {
                        <mat-error>City is required</mat-error>
                      }
                    </mat-form-field>

                    <mat-form-field appearance="outline" [class.opacity-75]="businessDetailsForm.get('state')?.disabled">
                      <mat-label>State</mat-label>
                      <input 
                        matInput 
                        formControlName="state" 
                        placeholder="State">
                      @if (businessDetailsForm.get('state')?.disabled) {
                        <mat-icon matSuffix class="text-gray-400">lock</mat-icon>
                      }
                    </mat-form-field>
                  </div>

                  <div class="flex gap-4 items-start">
                    <mat-form-field appearance="outline" class="flex-1" [class.opacity-75]="businessDetailsForm.get('postal_code')?.disabled">
                      <mat-label>Postal Code</mat-label>
                      <input 
                        matInput 
                        formControlName="postal_code" 
                        placeholder="Postal code">
                      @if (businessDetailsForm.get('postal_code')?.disabled) {
                        <mat-icon matSuffix class="text-gray-400">lock</mat-icon>
                      }
                    </mat-form-field>
                    
                    <div class="flex flex-col gap-2 pt-1">
                      <button 
                        type="button"
                        (click)="enableManualLocationEdit()"
                        class="flex items-center justify-center px-3 py-1.5 text-xs h-8 min-w-[80px] border border-blue-300 text-blue-600 bg-white rounded-md hover:bg-blue-50 transition-colors">
                        <mat-icon class="mr-1" style="font-size: 14px; width: 14px; height: 14px;">edit</mat-icon>
                        Edit
                      </button>
                      
                      <button 
                        type="button"
                        (click)="clearLocationData()"
                        class="flex items-center justify-center px-3 py-1.5 text-xs h-8 min-w-[80px] border border-red-300 text-red-600 bg-white rounded-md hover:bg-red-50 transition-colors">
                        <mat-icon class="mr-1" style="font-size: 14px; width: 14px; height: 14px;">clear</mat-icon>
                        Clear
                      </button>
                    </div>
                  </div>

                  <!-- Location status indicator -->
                  <div class="mt-3 p-2 rounded-md text-xs">
                    @if (businessDetailsForm.get('location')?.value?.coordinates) {
                      <div class="flex items-center text-green-700 bg-green-50 p-2 rounded-md border border-green-200">
                        <mat-icon class="text-sm mr-2">check_circle</mat-icon>
                        <span><strong>Location saved!</strong> Coordinates automatically detected from address.</span>
                      </div>
                    } @else {
                      <div class="flex items-center text-amber-700 bg-amber-50 p-2 rounded-md border border-amber-200">
                        <mat-icon class="text-sm mr-2">info</mat-icon>
                        <span>Use the address search above for automatic location detection and coordinates.</span>
                      </div>
                    }
                  </div>
                </div>
              </div>

              <!-- Contact Fields -->
              <div>
                <h4 class="text-md font-medium text-gray-900 mb-3">Contact Information</h4>
                <div class="space-y-4">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <mat-form-field appearance="outline">
                      <mat-label>Business Email</mat-label>
                      <input 
                        matInput 
                        type="email"
                        formControlName="contact_email" 
                        placeholder="business@example.com">
                      @if (businessDetailsForm.get('contact_email')?.hasError('email') && businessDetailsForm.get('contact_email')?.touched) {
                        <mat-error>Please enter a valid email address</mat-error>
                      }
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Business Phone</mat-label>
                      <input 
                        matInput 
                        type="tel"
                        appPhoneFormat
                        formControlName="contact_phone" 
                        placeholder="+1 (555) 123-4567">
                      @if (contact_phone?.hasError('required') && contact_phone?.touched) {
                        <mat-error>Business phone is required</mat-error>
                      }
                      @if (contact_phone?.hasError('usaPhone') && contact_phone?.touched) {
                        <mat-error>{{ contact_phone?.errors?.['usaPhone']?.message }}</mat-error>
                      }
                    </mat-form-field>
                  </div>

                  <mat-form-field appearance="outline" class="w-full">
                    <mat-label>Website URL (Optional)</mat-label>
                    <input 
                      matInput 
                      type="url"
                      formControlName="website" 
                      placeholder="https://your-website.com">
                  </mat-form-field>
                </div>
              </div>

              <!-- Image Upload Section -->
              <div>
                <h4 class="text-md font-medium text-gray-900 mb-3">Business Images</h4>
                <div class="space-y-6">
                  <!-- Logo Upload -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      Business Logo (Optional)
                    </label>
                    <div class="flex items-center space-x-4">
                      @if (logoPreview()) {
                        <div class="relative">
                          <img [src]="logoPreview()!" alt="Logo preview" class="w-20 h-20 object-cover rounded-lg border">
                          <button 
                            type="button"
                            (click)="removeLogoPreview()"
                            class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600">
                            <mat-icon class="text-sm">close</mat-icon>
                          </button>
                        </div>
                      } @else {
                        <div class="w-20 h-20 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center">
                          <mat-icon class="text-gray-400">image</mat-icon>
                        </div>
                      }
                      <div class="flex-1">
                        <input 
                          type="file" 
                          #logoInput
                          (change)="onLogoSelected($event)"
                          accept="image/*"
                          class="hidden">
                        <button 
                          type="button"
                          (click)="logoInput.click()"
                          class="flex items-center justify-center px-4 py-2 border border-gray-300 text-gray-700 bg-white rounded-md hover:bg-gray-50 transition-colors">
                          <mat-icon class="mr-2">upload</mat-icon>
                          Choose Logo
                        </button>
                        <p class="text-xs text-gray-500 mt-1">PNG, JPG up to 5MB</p>
                      </div>
                    </div>
                  </div>

                  <!-- Banner Upload -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      Banner Image (Optional)
                    </label>
                    <div class="space-y-4">
                      @if (bannerPreview()) {
                        <div class="relative">
                          <img [src]="bannerPreview()!" alt="Banner preview" class="w-full h-32 object-cover rounded-lg border">
                          <button 
                            type="button"
                            (click)="removeBannerPreview()"
                            class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-red-600">
                            <mat-icon class="text-sm">close</mat-icon>
                          </button>
                        </div>
                      } @else {
                        <div class="w-full h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center">
                          <div class="text-center">
                            <mat-icon class="text-gray-400 text-4xl mb-2">image</mat-icon>
                            <p class="text-gray-500">Banner Image</p>
                          </div>
                        </div>
                      }
                      <div>
                        <input 
                          type="file" 
                          #bannerInput
                          (change)="onBannerSelected($event)"
                          accept="image/*"
                          class="hidden">
                        <button 
                          type="button"
                          (click)="bannerInput.click()"
                          class="flex items-center justify-center px-4 py-2 border border-gray-300 text-gray-700 bg-white rounded-md hover:bg-gray-50 transition-colors">
                          <mat-icon class="mr-2">upload</mat-icon>
                          Choose Banner
                        </button>
                        <p class="text-xs text-gray-500 mt-1">PNG, JPG up to 5MB. Recommended: 1200x400px</p>
                      </div>
                    </div>
                  </div>

                  <!-- SOS Certification Upload -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      SOS Certification Documentation (Optional)
                    </label>
                    <p class="text-xs text-gray-500 mb-3">
                      Upload your Secretary of State certification or other business registration documents (multiple files allowed)
                    </p>
                    <div class="space-y-4">
                      <!-- Multiple files preview -->
                      @if (sosCertificationPreviews().length > 0) {
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                          @for (preview of sosCertificationPreviews(); track preview.preview) {
                            <div class="relative">
                              @if (preview.file && preview.file.type && preview.file.type.startsWith('image/')) {
                                <!-- Image preview -->
                                <img [src]="preview.preview" [alt]="preview.file.name" class="w-full h-32 object-cover rounded-lg border">
                              } @else if (!preview.file && (preview.preview.includes('.jpg') || preview.preview.includes('.jpeg') || preview.preview.includes('.png') || preview.preview.includes('/image/'))) {
                                <!-- URL-based image preview -->
                                <img [src]="preview.preview" alt="SOS Certification" class="w-full h-32 object-cover rounded-lg border">
                              } @else {
                                <!-- Document preview -->
                                <div class="w-full p-4 border-2 border-gray-300 rounded-lg bg-gray-50 flex items-center">
                                  <mat-icon class="text-blue-600 text-3xl mr-3">description</mat-icon>
                                  <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900">{{ preview.file?.name || 'SOS Certification Document' }}</p>
                                    <p class="text-xs text-gray-500">{{ preview.file?.type || 'Document' }}</p>
                                  </div>
                                </div>
                              }
                              <button 
                                type="button"
                                (click)="removeSosCertificationFile(preview)"
                                class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-red-600">
                                <mat-icon class="text-sm">close</mat-icon>
                              </button>
                            </div>
                          }
                        </div>
                      }
                      
                      <!-- Legacy single file preview (for backward compatibility) -->
                      @if (sosCertificationPreview() && sosCertificationPreviews().length === 0) {
                        <div class="relative">
                          @if (sosCertificationFile && sosCertificationFile.type.startsWith('image/')) {
                            <!-- Image preview -->
                            <img [src]="sosCertificationPreview()!" alt="SOS Certification preview" class="w-full h-32 object-cover rounded-lg border">
                          } @else {
                            <!-- Document preview -->
                            <div class="w-full p-4 border-2 border-gray-300 rounded-lg bg-gray-50 flex items-center">
                              <mat-icon class="text-blue-600 text-3xl mr-3">description</mat-icon>
                              <div class="flex-1">
                                <p class="text-sm font-medium text-gray-900">{{ sosCertificationPreview() }}</p>
                                <p class="text-xs text-gray-500">{{ sosCertificationFile?.type }}</p>
                              </div>
                            </div>
                          }
                          <button 
                            type="button"
                            (click)="removeSosCertificationPreview()"
                            class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-red-600">
                            <mat-icon class="text-sm">close</mat-icon>
                          </button>
                        </div>
                      }
                      
                      <!-- Upload area -->
                      @if (sosCertificationPreviews().length === 0 && !sosCertificationPreview()) {
                        <div class="w-full h-24 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center">
                          <div class="text-center">
                            <mat-icon class="text-gray-400 text-3xl mb-2">upload_file</mat-icon>
                            <p class="text-gray-500 text-sm">SOS Certification Documents</p>
                          </div>
                        </div>
                      }
                      
                      <div>
                        <input 
                          type="file" 
                          #sosCertificationInput
                          (change)="onSosCertificationSelected($event)"
                          accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                          multiple
                          class="hidden">
                        <button 
                          type="button"
                          (click)="sosCertificationInput.click()"
                          class="flex items-center justify-center px-4 py-2 border border-gray-300 text-gray-700 bg-white rounded-md hover:bg-gray-50 transition-colors">
                          <mat-icon class="mr-2">upload_file</mat-icon>
                          {{ sosCertificationPreviews().length > 0 ? 'Add More Certifications' : 'Choose Certifications' }}
                        </button>
                        <p class="text-xs text-gray-500 mt-1">PDF, DOC, DOCX, JPG, PNG up to 10MB each (multiple files allowed)</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="flex flex-col md:flex-row gap-4 justify-between items-stretch md:items-center">
                <button 
                  type="button"
                  (click)="previousStep(stepper)"
                  mat-stroked-button
                  color="accent"
                  class="flex items-center justify-center w-full md:w-auto order-2 md:order-1">
                  <mat-icon class="mr-2">arrow_back</mat-icon>
                  Previous
                </button>
                <div class="flex flex-col md:flex-row gap-4 items-stretch md:items-center order-1 md:order-2 w-full md:w-auto">
                  @if (!isBusinessDetailsValid()) {
                    <div class="text-sm text-amber-600 flex items-center">
                      <mat-icon class="text-sm mr-1">info</mat-icon>
                      Please complete required location fields to continue
                    </div>
                  }
                  <button 
                    type="button"
                    (click)="nextStep(stepper)"
                    [disabled]="!isBusinessDetailsValid()"
                    mat-raised-button
                    color="primary"
                    class="flex items-center justify-center w-full md:w-auto">
                    Next
                    <mat-icon class="ml-2">arrow_forward</mat-icon>
                  </button>
                </div>
              </div>
            </form>
          </mat-step>

          <!-- Step 3: Business Compliance & Operations -->
          <mat-step [stepControl]="businessComplianceForm" label="Compliance & Operations">
            <form [formGroup]="businessComplianceForm" class="p-6 space-y-6">
              <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                  Business Compliance & Operations
                </h3>
                <p class="text-gray-600 mb-6">
                  Provide additional business details and certifications.
                </p>
              </div>

              <!-- Business Stage -->
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Business Stage</mat-label>
                <mat-select formControlName="business_stage" required>
                  <mat-option value="side_gig">Side gig</mat-option>
                  <mat-option value="startup">Startup</mat-option>
                  <mat-option value="growing_business">Growing business</mat-option>
                  <mat-option value="established_business">Established business</mat-option>
                </mat-select>
                @if (businessComplianceForm.get('business_stage')?.hasError('required') && businessComplianceForm.get('business_stage')?.touched) {
                  <mat-error>Please select a business stage</mat-error>
                }
              </mat-form-field>

              <!-- Business Hours of Operation -->
              <div formGroupName="business_hours">
                <h4 class="text-md font-medium text-gray-900 mb-3">Business Hours of Operation</h4>
                <div class="space-y-3">
                  @for (day of ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']; track day) {
                    <div [formGroupName]="day" class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                      <div class="w-28 font-medium text-gray-700 capitalize">{{ day }}</div>
                      <mat-checkbox formControlName="closed" class="mr-3">Closed</mat-checkbox>
                      <mat-form-field appearance="outline" class="flex-1" [class.opacity-50]="businessComplianceForm.get('business_hours')?.get(day)?.get('closed')?.value">
                        <mat-label>Open</mat-label>
                        <input matInput type="time" formControlName="open" [disabled]="businessComplianceForm.get('business_hours')?.get(day)?.get('closed')?.value">
                      </mat-form-field>
                      <mat-form-field appearance="outline" class="flex-1" [class.opacity-50]="businessComplianceForm.get('business_hours')?.get(day)?.get('closed')?.value">
                        <mat-label>Close</mat-label>
                        <input matInput type="time" formControlName="close" [disabled]="businessComplianceForm.get('business_hours')?.get(day)?.get('closed')?.value">
                      </mat-form-field>
                    </div>
                  }
                </div>
              </div>

              <!-- Business Registered -->
              <div class="space-y-4">
                <div>
                  <h4 class="text-md font-medium text-gray-900 mb-3">Business Registration</h4>
                  <div class="flex items-center gap-4">
                    <label class="text-sm font-medium text-gray-700">Is your business registered?</label>
                    <mat-radio-group formControlName="business_registered" class="flex gap-4">
                      <mat-radio-button [value]="true">Yes</mat-radio-button>
                      <mat-radio-button [value]="false">No</mat-radio-button>
                    </mat-radio-group>
                  </div>
                </div>

                @if (businessComplianceForm.get('business_registered')?.value) {
                  <mat-form-field appearance="outline" class="w-full">
                    <mat-label>Registered State</mat-label>
                    <mat-select formControlName="registered_state" required>
                      @for (state of usStates; track state) {
                        <mat-option [value]="state">{{ state }}</mat-option>
                      }
                    </mat-select>
                    @if (businessComplianceForm.get('registered_state')?.hasError('required') && businessComplianceForm.get('registered_state')?.touched) {
                      <mat-error>Please select the registered state</mat-error>
                    }
                  </mat-form-field>
                }
              </div>

              <!-- Tax ID/EIN/SSN -->
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Tax ID/EIN/SSN</mat-label>
                <input 
                  matInput 
                  formControlName="tax_id" 
                  placeholder="SSN: 888-88-8888 or EIN: 88-8888888"
                  maxlength="12">
                <mat-hint>SSN format: 888-88-8888 (9 digits) or EIN format: 88-8888888 (9 digits)</mat-hint>
                @if (businessComplianceForm.get('tax_id')?.hasError('pattern') && businessComplianceForm.get('tax_id')?.touched) {
                  <mat-error>Please enter a valid Tax ID in format: SSN (888-88-8888) or EIN (88-8888888)</mat-error>
                }
              </mat-form-field>

              <!-- Certified WBE/MBE -->
              <div>
                <h4 class="text-md font-medium text-gray-900 mb-3">Business Certifications</h4>
                <div class="flex items-center gap-4">
                  <label class="text-sm font-medium text-gray-700">
                    Certified Women Business Enterprise or Minority Business Enterprise?
                  </label>
                  <mat-radio-group formControlName="is_certified_wbe_mbe" class="flex gap-4">
                    <mat-radio-button [value]="true">Yes</mat-radio-button>
                    <mat-radio-button [value]="false">No</mat-radio-button>
                  </mat-radio-group>
                </div>
              </div>

              <!-- Self-attestation Checkbox -->
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <mat-checkbox formControlName="woman_owned_attestation" required class="text-sm">
                  <span class="font-medium text-gray-900">
                    I confirm this business is 51-100% owned and operated by a woman.
                  </span>
                </mat-checkbox>
                @if (businessComplianceForm.get('woman_owned_attestation')?.hasError('required') && businessComplianceForm.get('woman_owned_attestation')?.touched) {
                  <div class="text-red-600 text-xs mt-2 ml-8">
                    <mat-icon class="text-sm align-middle">error</mat-icon>
                    You must confirm this attestation to continue
                  </div>
                }
              </div>

              <div class="flex flex-col md:flex-row gap-4 justify-between items-stretch md:items-center">
                <button 
                  type="button"
                  (click)="previousStep(stepper)"
                  mat-stroked-button
                  color="accent"
                  class="flex items-center justify-center w-full md:w-auto order-2 md:order-1">
                  <mat-icon class="mr-2">arrow_back</mat-icon>
                  Previous
                </button>
                <div class="flex flex-col md:flex-row gap-4 items-stretch md:items-center order-1 md:order-2 w-full md:w-auto">
                  @if (!isBusinessComplianceValid()) {
                    <div class="text-sm text-amber-600 flex items-center">
                      <mat-icon class="text-sm mr-1">info</mat-icon>
                      Please complete all required fields
                    </div>
                  }
                  <button 
                    type="button"
                    (click)="nextStep(stepper)"
                    [disabled]="!isBusinessComplianceValid()"
                    mat-raised-button
                    color="primary"
                    class="flex items-center justify-center w-full md:w-auto">
                    Next
                    <mat-icon class="ml-2">arrow_forward</mat-icon>
                  </button>
                </div>
              </div>
            </form>
          </mat-step>

          <!-- Step 4: Review & Submit -->
          <mat-step label="Review & Submit">
            <div class="p-6 space-y-6">
              <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                  Review Your Business Information
                </h3>
                <p class="text-gray-600 mb-6">
                  Please review your business details before submitting.
                </p>
              </div>

              <!-- Business Summary -->
              <div class="bg-gray-50 rounded-lg p-6 space-y-4">
                <div class="border-b border-gray-200 pb-4">
                  <h4 class="font-medium text-gray-900 mb-2">Business Information</h4>
                  <div class="space-y-2">
                    <div>
                      <span class="text-sm font-medium text-gray-600">Name:</span>
                      <span class="ml-2 text-gray-900">{{ businessInfoForm.get('name')?.value }}</span>
                    </div>
                    <div>
                      <span class="text-sm font-medium text-gray-600">Type:</span>
                      <span class="ml-2 text-gray-900">{{ businessInfoForm.get('business_type')?.value }}</span>
                    </div>
                    <div>
                      <span class="text-sm font-medium text-gray-600">Description:</span>
                      <div class="ml-2 text-gray-900 mt-1 text-sm">
                        {{ businessInfoForm.get('description')?.value }}
                      </div>
                    </div>
                  </div>
                </div>

                <div class="border-b border-gray-200 pb-4">
                  <h4 class="font-medium text-gray-900 mb-2">Location & Contact</h4>
                  <div class="space-y-2">
                    <div>
                      <span class="text-sm font-medium text-gray-600">Address:</span>
                      <div class="ml-2 text-gray-900">
                        @if (businessDetailsForm.get('address')?.value) {
                          <div>{{ businessDetailsForm.get('address')?.value }}</div>
                        }
                        <div>
                          {{ businessDetailsForm.get('city')?.value }}@if (businessDetailsForm.get('state')?.value) {<span>, {{ businessDetailsForm.get('state')?.value }}</span>} {{ businessDetailsForm.get('postal_code')?.value }}
                        </div>
                        @if (businessDetailsForm.get('country')?.value) {
                          <div>{{ businessDetailsForm.get('country')?.value || 'USA' }}</div>
                        }
                      </div>
                    </div>
                    @if (businessDetailsForm.get('contact_email')?.value) {
                      <div>
                        <span class="text-sm font-medium text-gray-600">Email:</span>
                        <span class="ml-2 text-gray-900">{{ businessDetailsForm.get('contact_email')?.value }}</span>
                      </div>
                    }
                    @if (businessDetailsForm.get('contact_phone')?.value) {
                      <div>
                        <span class="text-sm font-medium text-gray-600">Phone:</span>
                        <span class="ml-2 text-gray-900">{{ businessDetailsForm.get('contact_phone')?.value }}</span>
                      </div>
                    }
                    @if (businessDetailsForm.get('website')?.value) {
                      <div>
                        <span class="text-sm font-medium text-gray-600">Website:</span>
                        <span class="ml-2 text-gray-900">{{ businessDetailsForm.get('website')?.value }}</span>
                      </div>
                    }
                  </div>
                </div>

                <!-- Uploaded Images & Documents Section -->
                <div class="border-b border-gray-200 pb-4">
                  <h4 class="font-medium text-gray-900 mb-3">Uploaded Images & Documents</h4>
                  
                  <!-- Business Logo -->
                  <div class="mb-4">
                    <span class="text-sm font-medium text-gray-600 block mb-2">Business Logo:</span>
                    @if (logoPreview()) {
                      <div class="flex items-center">
                        <img [src]="logoPreview()!" alt="Business Logo" class="w-16 h-16 object-cover rounded-lg border border-gray-200">
                        <div class="ml-3">
                          <p class="text-sm text-gray-900 font-medium">Logo uploaded</p>
                          <p class="text-xs text-gray-500">Ready for display</p>
                        </div>
                      </div>
                    } @else {
                      <div class="flex items-center text-gray-500">
                        <div class="w-16 h-16 bg-gray-100 rounded-lg border border-gray-200 flex items-center justify-center">
                          <mat-icon class="text-gray-400">image</mat-icon>
                        </div>
                        <div class="ml-3">
                          <p class="text-sm">No logo uploaded</p>
                          <p class="text-xs">Optional - can be added later</p>
                        </div>
                      </div>
                    }
                  </div>

                  <!-- Banner Image -->
                  <div class="mb-4">
                    <span class="text-sm font-medium text-gray-600 block mb-2">Banner Image:</span>
                    @if (bannerPreview()) {
                      <div class="space-y-2">
                        <img [src]="bannerPreview()!" alt="Banner Image" class="w-full max-w-md h-24 object-cover rounded-lg border border-gray-200">
                        <div class="flex items-center">
                          <mat-icon class="text-green-600 text-base mr-2">check_circle</mat-icon>
                          <p class="text-sm text-gray-900 font-medium">Banner image uploaded</p>
                        </div>
                      </div>
                    } @else {
                      <div class="flex items-center text-gray-500">
                        <div class="w-full max-w-md h-24 bg-gray-100 rounded-lg border border-gray-200 flex items-center justify-center">
                          <mat-icon class="text-gray-400 text-2xl">image</mat-icon>
                        </div>
                        <div class="ml-3">
                          <p class="text-sm">No banner image uploaded</p>
                          <p class="text-xs">Optional - can be added later</p>
                        </div>
                      </div>
                    }
                  </div>

                  <!-- SOS Certification Documentation -->
                  <div class="mb-4">
                    <span class="text-sm font-medium text-gray-600 block mb-2">SOS Certification Documentation:</span>
                    @if (sosCertificationPreviews().length > 0) {
                      <div class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                          @for (preview of sosCertificationPreviews(); track preview.preview) {
                            <div class="border border-gray-200 rounded-lg p-3">
                              @if (preview.file && preview.file.type && preview.file.type.startsWith('image/')) {
                                <!-- Image preview -->
                                <img [src]="preview.preview" [alt]="preview.file.name" class="w-full h-20 object-cover rounded border mb-2">
                                <div class="flex items-center">
                                  <mat-icon class="text-blue-600 text-sm mr-1">image</mat-icon>
                                  <p class="text-xs text-gray-900 font-medium truncate">{{ preview.file.name }}</p>
                                </div>
                              } @else if (!preview.file && (preview.preview.includes('.jpg') || preview.preview.includes('.jpeg') || preview.preview.includes('.png') || preview.preview.includes('/image/'))) {
                                <!-- URL-based image preview -->
                                <img [src]="preview.preview" alt="SOS Certification" class="w-full h-20 object-cover rounded border mb-2">
                                <div class="flex items-center">
                                  <mat-icon class="text-blue-600 text-sm mr-1">image</mat-icon>
                                  <p class="text-xs text-gray-900 font-medium">Certification Image</p>
                                </div>
                              } @else {
                                <!-- Document preview -->
                                <div class="flex items-center p-2 bg-blue-50 rounded border">
                                  <mat-icon class="text-blue-600 text-2xl mr-2">description</mat-icon>
                                  <div class="flex-1 min-w-0">
                                    <p class="text-xs font-medium text-gray-900 truncate">{{ preview.file?.name || 'SOS Certification Document' }}</p>
                                    <p class="text-xs text-gray-500">{{ preview.file?.type || 'Document' }}</p>
                                  </div>
                                </div>
                              }
                            </div>
                          }
                        </div>
                        <div class="flex items-center">
                          <mat-icon class="text-green-600 text-base mr-2">check_circle</mat-icon>
                          <p class="text-sm text-gray-900 font-medium">
                            {{ sosCertificationPreviews().length }} certification {{ sosCertificationPreviews().length === 1 ? 'document' : 'documents' }} uploaded
                          </p>
                        </div>
                      </div>
                    } @else if (sosCertificationPreview()) {
                      <!-- Legacy single file display -->
                      <div class="space-y-2">
                        @if (sosCertificationFile && sosCertificationFile.type.startsWith('image/')) {
                          <img [src]="sosCertificationPreview()!" alt="SOS Certification" class="w-full max-w-md h-24 object-cover rounded-lg border border-gray-200">
                        } @else {
                          <div class="border border-gray-200 rounded-lg p-3 bg-blue-50 max-w-md">
                            <div class="flex items-center">
                              <mat-icon class="text-blue-600 text-2xl mr-3">description</mat-icon>
                              <div class="flex-1">
                                <p class="text-sm font-medium text-gray-900">{{ sosCertificationPreview() }}</p>
                                <p class="text-xs text-gray-500">{{ sosCertificationFile?.type || 'Document' }}</p>
                              </div>
                            </div>
                          </div>
                        }
                        <div class="flex items-center">
                          <mat-icon class="text-green-600 text-base mr-2">check_circle</mat-icon>
                          <p class="text-sm text-gray-900 font-medium">SOS certification document uploaded</p>
                        </div>
                      </div>
                    } @else {
                      <div class="flex items-center text-gray-500">
                        <div class="w-20 h-16 bg-gray-100 rounded-lg border border-gray-200 flex items-center justify-center">
                          <mat-icon class="text-gray-400">description</mat-icon>
                        </div>
                        <div class="ml-3">
                          <p class="text-sm">No certification documents uploaded</p>
                          <p class="text-xs">Optional - can be added later</p>
                        </div>
                      </div>
                    }
                  </div>
                </div>

                <!-- Business Compliance & Operations Section -->
                @if (businessComplianceForm.get('business_stage')?.value) {
                  <div class="border-t border-gray-200 pt-4">
                    <h4 class="font-medium text-gray-900 mb-3">Business Compliance & Operations</h4>
                    <div class="space-y-3">
                      <!-- Business Stage -->
                      <div>
                        <span class="text-sm font-medium text-gray-600">Business Stage:</span>
                        <span class="ml-2 text-gray-900 capitalize">{{ formatBusinessStage(businessComplianceForm.get('business_stage')?.value) }}</span>
                      </div>

                      <!-- Business Hours -->
                      @if (businessComplianceForm.get('business_hours')) {
                        <div>
                          <span class="text-sm font-medium text-gray-600 block mb-2">Business Hours:</span>
                          <div class="ml-2 space-y-1 text-sm">
                            @for (day of ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']; track day) {
                              @if (!businessComplianceForm.get('business_hours')?.get(day)?.get('closed')?.value) {
                                <div class="text-gray-700">
                                  <span class="font-medium capitalize">{{ day }}:</span>
                                  {{ businessComplianceForm.get('business_hours')?.get(day)?.get('open')?.value }} - {{ businessComplianceForm.get('business_hours')?.get(day)?.get('close')?.value }}
                                </div>
                              } @else {
                                <div class="text-gray-600">
                                  <span class="font-medium capitalize">{{ day }}:</span>
                                  <span class="text-gray-500">Closed</span>
                                </div>
                              }
                            }
                          </div>
                        </div>
                      }

                      <!-- Business Registered -->
                      @if (businessComplianceForm.get('business_registered')?.value !== null) {
                        <div>
                          <span class="text-sm font-medium text-gray-600">Business Registered:</span>
                          <span class="ml-2 text-gray-900">{{ businessComplianceForm.get('business_registered')?.value ? 'Yes' : 'No' }}</span>
                        </div>
                      }

                      <!-- Registered State -->
                      @if (businessComplianceForm.get('registered_state')?.value) {
                        <div>
                          <span class="text-sm font-medium text-gray-600">Registered State:</span>
                          <span class="ml-2 text-gray-900">{{ businessComplianceForm.get('registered_state')?.value }}</span>
                        </div>
                      }

                      <!-- Tax ID -->
                      @if (businessComplianceForm.get('tax_id')?.value) {
                        <div>
                          <span class="text-sm font-medium text-gray-600">Tax ID/EIN/SSN:</span>
                          <span class="ml-2 text-gray-900 font-mono">{{ businessComplianceForm.get('tax_id')?.value }}</span>
                        </div>
                      }

                      <!-- Certified WBE/MBE -->
                      @if (businessComplianceForm.get('is_certified_wbe_mbe')?.value !== null) {
                        <div>
                          <span class="text-sm font-medium text-gray-600">Certified WBE/MBE:</span>
                          <span class="ml-2 text-gray-900">{{ businessComplianceForm.get('is_certified_wbe_mbe')?.value ? 'Yes' : 'No' }}</span>
                        </div>
                      }

                      <!-- Woman Owned Attestation -->
                      @if (businessComplianceForm.get('woman_owned_attestation')?.value) {
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 mt-2">
                          <div class="flex items-start">
                            <mat-icon class="text-green-600 mr-2 text-base mt-0.5">check_circle</mat-icon>
                            <span class="text-sm text-green-900">This business is confirmed to be 51-100% owned and operated by a woman.</span>
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                }

                <div>
                  <h4 class="font-medium text-gray-900 mb-2">Next Steps</h4>
                  <div class="text-sm text-gray-600 space-y-1">
                    <div class="flex items-center">
                      <mat-icon class="text-green-600 mr-2 text-base">check_circle</mat-icon>
                      Your business profile will be created
                    </div>
                    <div class="flex items-center">
                      <mat-icon class="text-green-600 mr-2 text-base">check_circle</mat-icon>
                      You can add services and showcase your work
                    </div>
                    <div class="flex items-center">
                      <mat-icon class="text-green-600 mr-2 text-base">check_circle</mat-icon>
                      Customers can find and contact you
                    </div>
                  </div>
                </div>
              </div>

              <div class="flex flex-col md:flex-row gap-4 justify-between items-stretch md:items-center">
                <button 
                  type="button"
                  (click)="previousStep(stepper)"
                  mat-stroked-button
                  color="accent"
                  class="flex items-center justify-center w-full md:w-auto order-2 md:order-1">
                  <mat-icon class="mr-2">arrow_back</mat-icon>
                  Previous
                </button>
                <div class="flex flex-col md:flex-row gap-4 items-stretch md:items-center order-1 md:order-2 w-full md:w-auto">
                  @if (!isAllFormsValid() && !submitting()) {
                    <div class="text-sm text-red-600 flex items-center">
                      <mat-icon class="text-sm mr-1">error</mat-icon>
                      Please complete all required fields before submitting
                    </div>
                  }
                  <button 
                    type="button"
                    (click)="submitBusiness()"
                    [disabled]="submitting() || !isAllFormsValid()"
                    mat-raised-button
                    color="primary"
                    class="flex items-center justify-center w-full md:w-auto">
                    @if (submitting()) {
                      <ng-container>
                        <mat-icon class="mr-2 animate-spin">refresh</mat-icon>
                        {{ isEditMode() ? 'Updating Business...' : 'Creating Business...' }}
                      </ng-container>
                    } @else {
                      <ng-container>
                        <mat-icon class="mr-2">business</mat-icon>
                        {{ isEditMode() ? 'Update Business' : 'Create Business' }}
                      </ng-container>
                    }
                  </button>
                </div>
              </div>
            </div>
          </mat-step>
        </mat-stepper>
        <!-- </mat-card-content> -->
      </mat-card>
    </div>
  }
</div>
