<!-- Chat Window Container - Responsive Design -->
<div class="chat-window">
  <!-- Fixed Header -->
  <div class="chat-header">
    <div class="chat-header-content">
      <!-- Left side - Back button and participant info -->
      <div class="header-left">
        <button 
          (click)="navigateBack()"
          class="back-button">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        
        @if (chat(); as currentChat) {
          <div class="participant-info">
            <!-- Avatar -->
            @if (currentChat.project_id?.business_id?.logo_url) {
              <img 
                [src]="currentChat.project_id!.business_id!.logo_url!" 
                [alt]="currentChat.project_id!.business_id!.name"
                class="participant-avatar">
            } @else {
              <div class="participant-avatar-placeholder">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
              </div>
            }
            
            <div class="participant-details">
              <h2 class="participant-name">{{ currentChat.title }}</h2>
              <div class="participant-status">
                <span class="participant-username">{{ otherParticipant()?.last_name || 'Unknown User' }}</span>
                <div class="connection-status">
                  <div class="status-dot" [class.online]="isConnected()"></div>
                  <span class="status-text">{{ isConnected() ? 'Online' : 'Offline' }}</span>
                </div>
              </div>
            </div>
          </div>
        }
      </div>
      
      <!-- Right side - Actions -->
      <div class="header-actions">
        @if (chat(); as currentChat) {
          <!-- Mobile: Compact action button -->
          <div class="mobile-action">
            @if (canPerformAction('accept')) {
              <button 
                (click)="handleProjectAction('accept')"
                class="action-btn accept">
                Accept
              </button>
            }
            @if (canPerformAction('reject')) {
              <button 
                (click)="handleProjectAction('reject')"
                class="action-btn reject">
                Reject
              </button>
            }
            @if (canPerformAction('request_payment')) {
              <button 
                (click)="handleProjectAction('request_payment')"
                class="action-btn request-payment">
                Request Initial Payment
              </button>
            }
            @if (canPerformAction('start') && !canPerformAction('accept') && !canPerformAction('request_payment')) {
              <button 
                (click)="handleProjectAction('start')"
                class="action-btn start">
                Start
              </button>
            } @else if (canPerformAction('complete')) {
              <button 
                (click)="handleProjectAction('complete')"
                class="action-btn complete">
                Request Completion
              </button>
            } @else if (canPerformAction('approve_completion')) {
              <button 
                (click)="handleProjectAction('approve_completion')"
                class="action-btn complete">
                Approve Completion
              </button>
            } @else if (showReviewButton()) {
              <button 
                (click)="handleReviewAction()"
                class="action-btn review">
                {{ reviewButtonText() }}
              </button>
            }
            
            <!-- Report Button (Mobile) -->
            @if (otherParticipant()) {
              <button 
                (click)="openReportDialog()"
                class="action-btn report"
                title="Report User">
                <mat-icon>flag</mat-icon>
              </button>
            }
          </div>
          
          <!-- Desktop: Full action buttons -->
          <div class="desktop-actions">
            @if (canPerformAction('accept')) {
              <button 
                (click)="handleProjectAction('accept')"
                class="action-btn accept">
                Accept Project
              </button>
            }
            @if (canPerformAction('reject')) {
              <button 
                (click)="handleProjectAction('reject')"
                class="action-btn reject">
                Reject
              </button>
            }
            @if (canPerformAction('request_payment')) {
              <button 
                (click)="handleProjectAction('request_payment')"
                class="action-btn request-payment">
                Request Initial Payment
              </button>
            }
            @if (canPerformAction('start')) {
              <button 
                (click)="handleProjectAction('start')"
                class="action-btn start">
                Start Project
              </button>
            }
            @if (canPerformAction('complete')) {
              <button 
                (click)="handleProjectAction('complete')"
                class="action-btn complete">
                Request Completion
              </button>
            }
            @if (canPerformAction('approve_completion')) {
              <button 
                (click)="handleProjectAction('approve_completion')"
                class="action-btn complete">
                Approve Completion
              </button>
            }
            @if (canRequestPayment()) {
              <button 
                (click)="requestAdditionalPayment()"
                class="action-btn" style="background: #f59e0b; color: white;">
                Request Payment
              </button>
            }
            @if (showReviewButton()) {
              <button 
                (click)="handleReviewAction()"
                class="action-btn review">
                {{ reviewButtonText() }}
              </button>
            }
            
            <!-- Report Button (Desktop) -->
            @if (otherParticipant()) {
              <button 
                (click)="openReportDialog()"
                class="action-btn report"
                title="Report User">
                <mat-icon>flag</mat-icon>
                Report User
              </button>
            }
          </div>
        }
        
        <button 
          (click)="goToProjectDetails()"
          class="details-btn">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Messages Area -->
  <div class="messages-container">
    <!-- Loading State -->
    @if (loading() || messagesLoading()) {
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p class="loading-text">Loading conversation...</p>
      </div>
    }

    <!-- Error State -->
    @if (error() && !loading()) {
      <div class="error-state">
        <div class="error-content">
          <svg class="error-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span class="error-message">{{ error() }}</span>
        </div>
      </div>
    }

    <!-- Messages Scroll Area -->
    @if (!loading() && !messagesLoading() && !error()) {
      <div 
        #messagesContainer
        class="messages-scroll">
        
        <div class="messages-content">
          @if (hasMessages()) {
            <div class="messages-list">
              @for (message of messages(); track message._id; let i = $index) {
                <!-- Date Divider -->
                @if (shouldShowDateDivider(i)) {
                  <div class="date-divider">
                    <span class="date-label">
                      {{ formatMessageDate(message.createdAt) }}
                    </span>
                  </div>
                }

                <!-- Message -->
                <div class="message-wrapper" [class.my-message]="isMyMessage(message)">
                  <div class="message-container">
                    
                    <!-- Avatar (for other user's messages) -->
                    @if (!isMyMessage(message)) {
                      <div class="message-avatar">
                        <span class="avatar-initials">
                          {{ message.sender_id.email.charAt(0).toUpperCase() }}{{ message.sender_id.last_name.charAt(0).toUpperCase() }}
                        </span>
                      </div>
                    }

                    <!-- Message Bubble -->
                    <div class="message-bubble-container">
                      <!-- System/Project Update Message -->
                      @if (message.message_type === 'project_update') {
                        <div class="system-message">
                          <svg class="system-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                          </svg>
                          {{ message.content }}
                        </div>
                      } @else if (isPaymentRequest(message)) {
                        <!-- Payment Request Message -->
                        <div class="payment-request-message">
                          <div class="payment-header">
                            <mat-icon>payment</mat-icon>
                            <h4>Additional Payment Request</h4>
                            <span class="payment-status" [class]="'status-' + message.payment_status">
                              {{ message.payment_status }}
                            </span>
                          </div>
                          <div class="payment-details">
                            <div class="payment-amount">${{ message.payment_amount }}</div>
                            <div class="payment-description">{{ message.payment_description }}</div>
                            <p class="payment-content">{{ message.content }}</p>
                          </div>
                          @if (canRespondToPayment(message)) {
                            <div class="payment-actions">
                              <button 
                                class="action-btn approve"
                                (click)="approvePaymentRequest(message._id)">
                                Approve & Pay
                              </button>
                              <button 
                                class="action-btn reject"
                                (click)="rejectPaymentRequest(message._id)">
                                Reject
                              </button>
                            </div>
                          }
                          <div class="message-time">
                            {{ formatMessageTime(message.createdAt) }}
                          </div>
                        </div>
                      } @else if (isCompletionRequest(message)) {
                        <!-- Completion Request Message -->
                        <div class="completion-request-message">
                          <div class="completion-header">
                            <mat-icon>check_circle</mat-icon>
                            <h4>Project Completion Request</h4>
                            <span class="completion-status" [class]="'status-' + message.completion_status">
                              {{ message.completion_status }}
                            </span>
                          </div>
                          <div class="completion-content">
                            <p>{{ message.content }}</p>
                          </div>
                          @if (canRespondToCompletion(message)) {
                            <div class="completion-actions">
                              <button 
                                class="action-btn approve"
                                (click)="approveCompletion()">
                                Approve Completion
                              </button>
                              <button 
                                class="action-btn reject"
                                (click)="rejectCompletion()">
                                Request Changes
                              </button>
                            </div>
                          }
                          <div class="message-time">
                            {{ formatMessageTime(message.createdAt) }}
                          </div>
                        </div>
                      } @else {
                        <!-- Regular Message -->
                        <div 
                          class="message-bubble"
                          [class.my-bubble]="isMyMessage(message)"
                          [class.other-bubble]="!isMyMessage(message)">
                          
                          <!-- File Attachment -->
                          @if (isImageFile(message)) {
                            <div class="image-attachment">
                              <img 
                                [src]="message.file_url" 
                                [alt]="message.file_name || 'Image'"
                                class="attachment-image"
                                (click)="downloadFile(message.file_url!, message.file_name || 'image')">
                              @if (message.content && message.content !== message.file_name) {
                                <p class="message-text">{{ message.content }}</p>
                              }
                            </div>
                          } @else if (isFileMessage(message)) {
                            <div class="file-attachment">
                              <div class="file-info">
                                <mat-icon class="file-icon">attach_file</mat-icon>
                                <div class="file-details">
                                  <span class="file-name">{{ message.file_name }}</span>
                                  @if (message.file_size) {
                                    <span class="file-size">{{ formatFileSize(message.file_size) }}</span>
                                  }
                                </div>
                                <button 
                                  class="download-btn"
                                  (click)="downloadFile(message.file_url!, message.file_name || 'file')">
                                  <mat-icon>download</mat-icon>
                                </button>
                              </div>
                              @if (message.content && message.content !== message.file_name) {
                                <p class="message-text">{{ message.content }}</p>
                              }
                            </div>
                          } @else {
                            <!-- Text Message -->
                            <p class="message-text">{{ message.content }}</p>
                          }
                          
                          @if (message.is_edited) {
                            <span class="edited-indicator">(edited)</span>
                          }
                          
                          <!-- Message time -->
                          <div class="message-time">
                            {{ formatMessageTime(message.createdAt) }}
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>
          } @else {
            <!-- Empty State -->
            <div class="empty-state">
              <div class="empty-icon">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
              </div>
              <h3 class="empty-title">Start the conversation</h3>
              <p class="empty-description">
                No messages yet. Send the first message to start discussing your project 
                <span class="project-name">"{{ chat()?.title }}"</span>
              </p>
            </div>
          }
        </div>
      </div>
    }
  </div>

  <!-- Fixed Message Input -->
  @if (!loading() && !error()) {
    @if (isChatDisabled()) {
      <!-- Chat Disabled State -->
      <div class="input-container">
        <div class="chat-disabled-container">
          <div class="chat-disabled-content">
            <mat-icon class="disabled-icon">lock</mat-icon>
            <div class="disabled-text">
              <h4>{{ chatDisabledMessage() }}</h4>
              <p>This conversation has been archived and is now read-only.</p>
            </div>
          </div>
        </div>
      </div>
    } @else {
      <!-- Active Chat Input -->
      <div class="input-container">
      <!-- Typing Indicator -->
      @if (typingUsers().length > 0) {
        <div class="typing-indicator">
          <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
          <span class="typing-text">{{ getTypingText() }}</span>
        </div>
      }
      
      <!-- File Upload Progress -->
      @if (uploadingFiles()) {
        <div class="upload-progress">
          <div class="upload-spinner"></div>
          <span class="upload-text">Uploading files...</span>
        </div>
      }

      <!-- Selected Files Preview -->
      @if (selectedFiles().length > 0 && !uploadingFiles()) {
        <div class="selected-files">
          @for (file of selectedFiles(); track $index) {
            <div class="file-preview">
              <mat-icon class="file-icon">{{ getFileIcon(file) }}</mat-icon>
              <div class="file-info">
                <span class="file-name">{{ file.name }}</span>
                <span class="file-size">{{ formatFileSize(file.size) }}</span>
              </div>
              <button 
                type="button" 
                (click)="removeSelectedFile($index)"
                class="remove-file-btn">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          }
          <div class="file-actions">
            <button 
              type="button" 
              (click)="uploadFiles(selectedFiles())"
              class="upload-btn">
              <mat-icon>cloud_upload</mat-icon>
              Upload Files
            </button>
            <button 
              type="button" 
              (click)="selectedFiles.set([])"
              class="cancel-btn">
              Cancel
            </button>
          </div>
        </div>
      }
      
      <div class="input-form-container">
        <!-- Hidden File Input -->
        <input 
          type="file"
          id="fileInput"
          multiple
          (change)="onFileSelect($event)"
          accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar"
          style="display: none;">
        
        <form [formGroup]="messageForm" (ngSubmit)="sendMessage()" class="message-form">
          <button 
            type="button"
            (click)="triggerFileInput()"
            class="attachment-button"
            [disabled]="uploadingFiles()">
            <mat-icon>attach_file</mat-icon>
          </button>
          
          <div class="input-wrapper">
            <textarea 
              formControlName="content"
              placeholder="Type your message..."
              (input)="onTextareaInput()"
              (keydown)="onTextareaKeydown($event)"
              rows="1"
              class="message-input"></textarea>
          </div>
          
          <button 
            type="submit"
            [disabled]="!messageForm.valid || sendingMessage() || uploadingFiles()"
            class="send-button"
            [class.sending]="sendingMessage()">
            @if (sendingMessage()) {
              <div class="send-spinner"></div>
            } @else {
              <svg class="send-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
              </svg>
            }
          </button>
        </form>
      </div>
      </div> <!-- Close active chat input-container -->
    } <!-- Close active chat conditional -->
  } <!-- Close @if (!loading() && !error()) -->
</div>
