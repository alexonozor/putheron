<div class=" min-h-screen bg-gray-50">
  <!-- Header with Subheader Component -->
  
    <div class="lg:max-w-7xl max-w-12xl">
      <div class="px-6 pt-6">
        <app-dashboard-subheader 
          title="Earnings & Payments" 
          subtitle="Manage your earnings, track payments, and request withdrawals">
          <!-- Stripe Actions Button with Dropdown Menu -->
          <button 
            [matMenuTriggerFor]="stripeMenu"
            mat-raised-button 
            matButton="filled"
            [color]="hasStripeAccount() ? 'primary' : 'accent'"
            [disabled]="stripeLoading()"
            class="flex items-center gap-2">
            <span>{{ stripeLoading() ? 'Loading...' : 'Stripe Account' }}</span>
            <mat-icon class="ml-1">arrow_drop_down</mat-icon>
          </button>

          <mat-menu #stripeMenu="matMenu">
            @if (hasStripeAccount()) {
              <button 
                mat-menu-item 
                (click)="handleStripeAction('dashboard')"
                [disabled]="stripeLoading()">
                <mat-icon>dashboard</mat-icon>
                <span>View Stripe Dashboard</span>
              </button>
              <button 
                mat-menu-item 
                (click)="handleStripeAction('disconnect')"
                [disabled]="stripeLoading()">
                <mat-icon>link_off</mat-icon>
                <span>Disconnect Account</span>
              </button>
            } @else {
              <button 
                mat-menu-item 
                (click)="handleStripeAction('connect')"
                [disabled]="stripeLoading()">
                <mat-icon>link</mat-icon>
                <span>Connect Stripe Account</span>
              </button>
            }
            @if (canWithdrawToStripe()) {
              <mat-divider></mat-divider>
              <button 
                mat-menu-item 
                (click)="withdrawToStripe()"
                [disabled]="stripeLoading()">
                <mat-icon>account_balance_wallet</mat-icon>
                <span>Withdraw Funds</span>
              </button>
            }
          </mat-menu>
        </app-dashboard-subheader>
      </div>

      <!-- Loading State -->
      @if (loading()) {
        <div class="px-6 flex items-center justify-center py-12">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
      }

      <!-- Error State -->
      @else if (error()) {
        <div class="px-6">
          <mat-card class="bg-red-50 border-l-4 border-red-400">
            <mat-card-content class="p-6">
              <div class="flex items-start gap-4">
                <mat-icon class="text-red-600 text-4xl mt-1">error</mat-icon>
                <div class="flex-1">
                  <h3 class="text-lg font-semibold text-red-900 mb-2">Error Loading Data</h3>
                  <p class="text-red-700 mb-4">{{ error() }}</p>
                  <button 
                    (click)="retryLoad()"
                    mat-raised-button 
                    color="warn">
                    <mat-icon class="mr-2">refresh</mat-icon>
                    Try Again
                  </button>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      }

      <!-- Main Content -->
      @else if (earningsSummary()) {
        <div class="px-6 space-y-6 pb-12">
          <!-- Summary Cards Component -->
           <div>
            <app-earnings-summary-cards 
            [summary]="earningsSummary()"
            [stripeConnectionStatus]="stripeConnectionStatus()">
            </app-earnings-summary-cards>
           </div>
          

      <!-- Filters Section with Search Component -->
       <div>
        <app-business-search-filter 
                [searchTerm]="filterForm.get('search')?.value || ''"
                [viewMode]="viewMode()"
                [hideViewModeToggle]="false"
                (searchChange)="filterForm.patchValue({ search: $event })"
                (viewModeChange)="setViewMode($event)"
                (clearSearch)="filterForm.patchValue({ search: '' })">
                
                <!-- Date Range Filter -->
                <div class="w-full sm:w-56">
                  <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
                    <mat-label>Date Range</mat-label>
                    <mat-date-range-input [rangePicker]="picker" [formGroup]="filterForm">
                      <input matStartDate formControlName="startDate" placeholder="Start date">
                      <input matEndDate formControlName="endDate" placeholder="End date">
                    </mat-date-range-input>
                    <mat-icon matPrefix>date_range</mat-icon>
                    <mat-date-range-picker #picker></mat-date-range-picker>
                  </mat-form-field>
                </div>

                <!-- Activity Type Filter -->
                <div class="w-full sm:w-56">
                  <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
                    <mat-label>Activity Type</mat-label>
                    <mat-select formControlName="activityFilter" (selectionChange)="onActivityFilterChange($event)">
                      <mat-option value="">All Activities</mat-option>
                      <mat-option value="project_started">Project Started</mat-option>
                      <mat-option value="project_completed">Project Completed</mat-option>
                      <mat-option value="additional_payment">Additional Payment</mat-option>
                      <mat-option value="payment_cleared">Payment Cleared</mat-option>
                      <mat-option value="withdrawal">Withdrawal</mat-option>
                      <mat-option value="refund">Refund</mat-option>
                      <mat-option value="platform_fee">Platform Fee</mat-option>
                    </mat-select>
                    <mat-icon matPrefix>filter_list</mat-icon>
                  </mat-form-field>
                </div>

                <!-- Clear Filters Button -->
                @if (hasActiveFilters()) {
                  <button 
                    mat-stroked-button
                    (click)="clearFilters()">
                    <mat-icon>clear</mat-icon>
                    Clear Filters
                  </button>
                }
        </app-business-search-filter> 
       </div>
              

          <!-- Transaction & Withdrawal History -->
          <mat-card class="overflow-hidden bg-white!">
            <mat-card-header class="p-6! border-b border-gray-200">
              <mat-card-title>Transaction History</mat-card-title>
              <mat-card-subtitle>View your earnings and withdrawal history</mat-card-subtitle>
            </mat-card-header>

            <mat-tab-group>
              <!-- Earnings Tab -->
              <mat-tab label="Earnings">
                <app-earnings-transaction-history
                  [transactions]="transactions()"
                  [filteredTransactions]="filteredTransactions()"
                  [loadingTransactions]="loadingTransactions()"
                  [viewMode]="viewMode()"
                  [hasActiveFilters]="hasActiveFilters()"
                  (clearFilters)="handleClearFilters()">
                </app-earnings-transaction-history>
              </mat-tab>

              <!-- Withdrawals Tab -->
              <mat-tab label="Withdrawals">
                <app-earnings-withdrawals-history
                  [withdrawals]="withdrawals()"
                  [loading]="stripeLoading()">
                </app-earnings-withdrawals-history>
              </mat-tab>
            </mat-tab-group>
          </mat-card>
        </div>
      }
    </div>
  
</div>
