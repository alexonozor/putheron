<div class="min-h-screen bg-gray-50">
  @if (loading()) {
    <div class="flex justify-center items-center py-20">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>
  } @else if (error()) {
    <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <div class="text-center py-12 bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="text-red-400 mb-4">
          <mat-icon class="text-6xl">error_outline</mat-icon>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">{{ error() }}</h3>
        <div class="space-x-4">
          <button 
            (click)="goBack()"
            class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
            Go Back
          </button>
          <button 
            (click)="loadData()"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
            Try Again
          </button>
        </div>
      </div>
    </div>
  } @else if (!hasBusinesses()) {
    <!-- No Businesses State -->
    <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <div class="text-center py-12 bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="mx-auto h-12 w-12 text-gray-400 mb-4">
          <mat-icon style="font-size: 48px; height: 48px; width: 48px;">business</mat-icon>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No businesses found</h3>
        <p class="text-sm text-gray-500 mb-6">You need to create a business before adding services.</p>
        <button
          routerLink="/dashboard/businesses/create-business"
          class="bg-gray-900 hover:bg-gray-800 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center">
          <mat-icon class="mr-2">add</mat-icon>
          Create Business
        </button>
      </div>
    </div>
  } @else {
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Header -->
      <div class="mb-8">
        <button 
          (click)="goBack()"
          class="mb-4 flex items-center text-gray-600 hover:text-gray-800 transition-colors">
          <mat-icon class="mr-2">arrow_back</mat-icon>
          Back to Services
        </button>
        
        <div class="text-center">
          <h1 class="text-3xl font-bold text-gray-900 mb-2">
            {{ pageTitle() }}
          </h1>
          <p class="text-gray-600">
            @if (isEditMode()) {
              Update your service information and settings
            } @else {
              Create a new service for your business
            }
          </p>
        </div>
      </div>

      <!-- Service Creation/Edit Form -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <mat-stepper #stepper [linear]="true" class="service-stepper">
          
          <!-- Step 1: Service Information -->
          <mat-step [stepControl]="serviceInfoForm" label="Service Information">
            <form [formGroup]="serviceInfoForm" class="p-6 space-y-6">
              <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                  Service Details
                </h3>
                <p class="text-gray-600 mb-6">
                  Provide basic information about your service.
                </p>
              </div>

              <!-- Business Selection (only for create mode) -->
              @if (!isEditMode()) {
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Business</mat-label>
                  <mat-select formControlName="business_id" required>
                    @for (business of userBusinesses(); track business._id) {
                      <mat-option [value]="business._id">
                        {{ business.name }}
                      </mat-option>
                    }
                  </mat-select>
                  @if (business_id?.hasError('required') && business_id?.touched) {
                    <mat-error>Please select a business</mat-error>
                  }
                </mat-form-field>
              }

              <!-- Service Name -->
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Service Name</mat-label>
                <input 
                  matInput 
                  formControlName="name" 
                  placeholder="e.g., Web Design, Logo Creation"
                  required>
                @if (name?.hasError('required') && name?.touched) {
                  <mat-error>Service name is required</mat-error>
                }
                @if (name?.hasError('minlength') && name?.touched) {
                  <mat-error>Service name must be at least 2 characters</mat-error>
                }
                @if (name?.hasError('maxlength') && name?.touched) {
                  <mat-error>Service name cannot exceed 100 characters</mat-error>
                }
              </mat-form-field>

              <!-- Short Description -->
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Short Description</mat-label>
                <textarea
                  matInput
                  formControlName="short_description"
                  rows="2"
                  placeholder="Brief description for search results and previews"
                  maxlength="160"
                ></textarea>
                <mat-hint align="end">{{ (short_description?.value || '').length }}/160 characters</mat-hint>
                @if (short_description?.hasError('maxlength') && short_description?.touched) {
                  <mat-error>Short description cannot exceed 160 characters</mat-error>
                }
              </mat-form-field>

              <!-- Description -->
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Full Description</mat-label>
                <textarea
                  matInput
                  formControlName="description"
                  rows="4"
                  placeholder="Detailed description of your service"
                ></textarea>
              </mat-form-field>

              <div class="flex justify-end">
                <button 
                  type="button"
                  (click)="nextStep(stepper)"
                  [disabled]="!isServiceInfoValid()"
                  class="bg-gray-900 hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center">
                  Next
                  <mat-icon class="ml-2">arrow_forward</mat-icon>
                </button>
              </div>
            </form>
          </mat-step>

          <!-- Step 2: Pricing & Features -->
          <mat-step [stepControl]="servicePricingForm" label="Pricing & Features">
            <form [formGroup]="servicePricingForm" class="p-6 space-y-6">
              <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                  Pricing & Service Features
                </h3>
                <p class="text-gray-600 mb-6">
                  Set your pricing and define what's included in your service.
                </p>
              </div>

              <!-- Pricing Section -->
              <div>
                <h4 class="text-md font-medium text-gray-900 mb-3">Pricing Information</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <mat-form-field appearance="outline">
                    <mat-label>Price</mat-label>
                    <input
                      matInput
                      type="number"
                      formControlName="price"
                      min="0"
                      step="0.01"
                      placeholder="0.00"
                    />
                    @if (price?.hasError('min') && price?.touched) {
                      <mat-error>Price cannot be negative</mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Pricing Type</mat-label>
                    <mat-select formControlName="pricing_type">
                      @for (type of pricingTypes; track type) {
                        <mat-option [value]="type">
                          {{ type | titlecase }}
                        </mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </div>

                <!-- Duration -->
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Duration</mat-label>
                  <input
                    matInput
                    formControlName="duration"
                    placeholder="e.g., 2-3 weeks, 1 hour"
                  />
                </mat-form-field>
              </div>

              <!-- Features & Tags Section -->
              <div>
                <h4 class="text-md font-medium text-gray-900 mb-3">Service Details</h4>
                
                <!-- Features -->
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Features</mat-label>
                  <textarea
                    matInput
                    formControlName="features"
                    rows="3"
                    placeholder="Feature 1, Feature 2, Feature 3"
                  ></textarea>
                  <mat-hint>Separate features with commas</mat-hint>
                </mat-form-field>

                <!-- Tags (moved from serviceInfoForm) -->
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Tags</mat-label>
                  <input
                    matInput
                    formControlName="tags"
                    placeholder="tag1, tag2, tag3"
                  />
                  <mat-hint>Separate tags with commas</mat-hint>
                </mat-form-field>
              </div>

              <!-- Status Toggles -->
              <div>
                <h4 class="text-md font-medium text-gray-900 mb-3">Service Status</h4>
                <div class="space-y-4">
                  <mat-checkbox formControlName="is_active">
                    Active (visible to customers)
                  </mat-checkbox>

                  <mat-checkbox formControlName="is_featured">
                    Featured service
                  </mat-checkbox>
                </div>
              </div>

              <div class="flex justify-between">
                <button 
                  type="button"
                  (click)="previousStep(stepper)"
                  class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-lg font-medium transition-colors flex items-center">
                  <mat-icon class="mr-2">arrow_back</mat-icon>
                  Previous
                </button>
                <button 
                  type="button"
                  (click)="nextStep(stepper)"
                  [disabled]="!isServicePricingValid()"
                  class="bg-gray-900 hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center">
                  Next
                  <mat-icon class="ml-2">arrow_forward</mat-icon>
                </button>
              </div>
            </form>
          </mat-step>

          <!-- Step 3: Service Images & Finish -->
          <mat-step label="Images & Finish">
            <div class="p-6 space-y-6">
              <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                  Service Images
                </h3>
                <p class="text-gray-600 mb-6">
                  Add images to showcase your service (optional). You can upload up to 5 images, max 5MB each.
                </p>
              </div>

              <!-- Existing Images (for edit mode) -->
              @if (isEditMode() && existingImages().length > 0) {
                <div>
                  <h4 class="text-md font-medium text-gray-900 mb-3">Current Images</h4>
                  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
                    @for (imageUrl of existingImages(); track imageUrl; let i = $index) {
                      <div class="relative group">
                        <img 
                          [src]="imageUrl" 
                          [alt]="'Service image ' + (i + 1)"
                          class="w-full h-32 object-cover rounded-lg border border-gray-200">
                        <button
                          type="button"
                          (click)="removeExistingImage(imageUrl)"
                          class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                          <mat-icon class="text-sm">close</mat-icon>
                        </button>
                      </div>
                    }
                  </div>
                </div>
              }

              <!-- Image Upload Area -->
              <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                <div class="text-center">
                  <mat-icon class="text-4xl text-gray-400 mb-4">cloud_upload</mat-icon>
                  <h4 class="text-lg font-medium text-gray-900 mb-2">Upload Images</h4>
                  <p class="text-gray-600 mb-4">Drag and drop images here, or click to select files</p>
                  
                  <input
                    type="file"
                    #fileInput
                    (change)="onImageSelect($event)"
                    multiple
                    accept="image/*"
                    class="hidden">
                  
                  <div class="flex justify-center">
                    <button
                      type="button"
                      (click)="fileInput.click()"
                      [disabled]="selectedImages().length + existingImages().length >= 5"
                      class="bg-gray-900 hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center">
                      <mat-icon class="mr-2">add_photo_alternate</mat-icon>
                      Select Images
                    </button>
                  </div>
                  
                  <p class="text-sm text-gray-500 mt-2">
                    {{ selectedImages().length + existingImages().length }} of 5 images selected
                  </p>
                </div>
              </div>

              <!-- Selected Images Preview -->
              @if (selectedImages().length > 0) {
                <div>
                  <h4 class="text-md font-medium text-gray-900 mb-3">New Images to Upload</h4>
                  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    @for (imageUrl of imagePreviewUrls(); track imageUrl; let i = $index) {
                      <div class="relative group">
                        <img 
                          [src]="imageUrl" 
                          [alt]="'Preview ' + (i + 1)"
                          class="w-full h-32 object-cover rounded-lg border border-gray-200">
                        <button
                          type="button"
                          (click)="removeImage(i)"
                          class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                          <mat-icon class="text-sm">close</mat-icon>
                        </button>
                      </div>
                    }
                  </div>
                </div>
              }

              <!-- Upload Progress -->
              @if (uploadingImages()) {
                <div class="flex items-center justify-center py-4">
                  <mat-icon class="animate-spin mr-2">refresh</mat-icon>
                  <span>Uploading images...</span>
                </div>
              }

              <!-- Navigation Buttons -->
              <div class="flex justify-between">
                <button 
                  type="button"
                  (click)="previousStep(stepper)"
                  class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-lg font-medium transition-colors flex items-center">
                  <mat-icon class="mr-2">arrow_back</mat-icon>
                  Back
                </button>
                <button 
                  type="button"
                  (click)="onSubmit()"
                  [disabled]="!canSubmitService()"
                  class="bg-gray-900 hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center">
                  @if (submitting()) {
                    <ng-container>
                      <mat-icon class="animate-spin mr-2">hourglass_empty</mat-icon>
                      {{ isEditMode() ? 'Updating...' : 'Creating...' }}
                    </ng-container>
                  } @else {
                    <ng-container>
                      <mat-icon class="mr-2">{{ isEditMode() ? 'save' : 'add' }}</mat-icon>
                      {{ submitButtonText() }}
                    </ng-container>
                  }
                </button>
              </div>
            </div>
          </mat-step>

        </mat-stepper>
      </div>
    </div>
  }
</div>
