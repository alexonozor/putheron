<!-- Notification Bell Icon -->
@if (unreadCount() > 0) {
<button mat-icon-button [matMenuTriggerFor]="notificationMenu" (menuOpened)="onMenuOpened()">
  <mat-icon [matBadge]="unreadCount() > 99 ? '99+' : unreadCount()"
    matBadgePosition="after" matBadgeColor="warn" class="material-icons-outlined">notifications_none</mat-icon>
</button>
} @else {
<button mat-icon-button [matMenuTriggerFor]="notificationMenu" (menuOpened)="onMenuOpened()" class="text-gray-600 hover:text-primary-600">
  <mat-icon class="material-icons-outlined">notifications_none</mat-icon>
</button>
}

<!-- Notification Menu -->
<mat-menu #notificationMenu="matMenu" class="notification-menu" xPosition="before">
  <!-- Header -->
  <div class="notification-header" (click)="$event.stopPropagation()">
    <div class="flex items-center justify-between px-4 py-3">
      <h3 class="text-sm font-semibold text-gray-900">Notifications</h3>
      <div class="flex items-center gap-3">
        @if (unreadCount() > 0) {
        <button 
          (click)="markAllAsRead(); $event.stopPropagation()" 
          class="text-xs text-blue-600 hover:text-blue-800 font-medium"
          [disabled]="isMarkingAllRead">
          {{ isMarkingAllRead ? 'Marking...' : 'Mark all read' }}
        </button>
        }
        <a routerLink="/dashboard/notifications" class="text-xs text-gray-600 hover:text-gray-800 font-medium">
          View all
        </a>
      </div>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Notifications List -->
  <div class="notification-list">
    @if (isLoading()) {
    <div class="notification-empty">
      <mat-spinner diameter="32"></mat-spinner>
    </div>
    } @else if (recentNotifications().length === 0) {
    <div class="notification-empty">
      <mat-icon class="empty-icon">notifications_none</mat-icon>
      <p class="text-sm text-gray-500">No notifications yet</p>
    </div>
    } @else {
    @for (notification of recentNotifications(); track notification._id) {
    <button mat-menu-item class="notification-item !h-auto !p-3" [class]="getNotificationStyles(notification)" (click)="handleNotificationClick(notification)">
      <div class="flex items-start gap-3 w-full">
        <!-- Icon -->
        <div class="flex-shrink-0 mt-0.5">
          <span class="text-lg">{{ getNotificationIcon(notification.type) }}</span>
        </div>

        <!-- Content -->
        <div class="flex-1 min-w-0">
          <div class="flex items-start justify-between gap-2">
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-gray-900 line-clamp-1">
                {{ notification.title }}
              </p>
              <p class="text-xs text-gray-600 mt-1 line-clamp-2">
                {{ notification.message }}
              </p>
              <p class="text-xs text-gray-400 mt-1">
                {{ formatTimeAgo(notification.createdAt) }}
              </p>
            </div>

            <!-- Unread indicator -->
            @if (!notification.is_read) {
            <div class="w-2 h-2 bg-blue-500 rounded-full flex-shrink-0 mt-1"></div>
            }
          </div>
        </div>
      </div>
    </button>
    @if (!$last) {
    <mat-divider></mat-divider>
    }
    }
    }
  </div>
</mat-menu>