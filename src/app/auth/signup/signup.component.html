<div class="signup-container">
  <!-- Registration Form -->
  @if (!showVerificationStep()) {
    <div class="text-center mb-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-2">Join Our Community</h2>
      <p class="text-gray-600">Create your account to get started</p>
    </div>

    <form [formGroup]="signupForm" (ngSubmit)="onSubmit()" class="space-y-6">
    <!-- Name Fields Row -->
    <div class="grid grid-cols-2 gap-4">
      <mat-form-field appearance="outline">
        <mat-label>First Name</mat-label>
        <input
          matInput
          formControlName="firstName"
          placeholder="First name"
          [disabled]="loading()"
        />
        <mat-icon matSuffix>person</mat-icon>
        @if (firstNameControl?.invalid && firstNameControl?.touched) {
          <mat-error>Required</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Last Name</mat-label>
        <input
          matInput
          formControlName="lastName"
          placeholder="Last name"
          [disabled]="loading()"
        />
        @if (lastNameControl?.invalid && lastNameControl?.touched) {
          <mat-error>Required</mat-error>
        }
      </mat-form-field>
    </div>

    <!-- Contact & Location -->
    <mat-form-field appearance="outline">
      <mat-label>Phone Number</mat-label>
      <input
        matInput
        type="tel"
        appPhoneFormat
        formControlName="phone"
        placeholder="(555) 123-4567"
        [disabled]="loading()"
      />
      <mat-icon matSuffix>phone</mat-icon>
      @if (phoneControl?.hasError('required') && phoneControl?.touched) {
        <mat-error>Phone number is required</mat-error>
      }
      @if (phoneControl?.hasError('usaPhone') && phoneControl?.touched) {
        <mat-error>{{ phoneControl?.errors?.['usaPhone']?.message }}</mat-error>
      }
    </mat-form-field>

    <div class="grid grid-cols-2 gap-4">
      <mat-form-field appearance="outline">
        <mat-label>State</mat-label>
        <mat-select
          formControlName="state"
          [disabled]="loading()"
          (selectionChange)="onStateSelected($event.value)"
        >
          <mat-option value="">Select state</mat-option>
          @for (state of usStates; track state.code) {
            <mat-option [value]="state.code">{{ state.name }}</mat-option>
          }
        </mat-select>
        <mat-icon matSuffix>location_on</mat-icon>
        @if (stateControl?.invalid && stateControl?.touched) {
          <mat-error>Required</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>City</mat-label>
        <mat-select
          formControlName="city"
          [disabled]="loading() || availableCities().length === 0"
        >
          @if (availableCities().length === 0) {
            <mat-option value="">Select state</mat-option>
          } @else {
            <mat-option value="">Select city</mat-option>
            @for (city of availableCities(); track city.name) {
              <mat-option [value]="city.name">{{ city.name }}</mat-option>
            }
          }
        </mat-select>
        <mat-icon matSuffix>location_city</mat-icon>
        @if (cityControl?.invalid && cityControl?.touched) {
          <mat-error>Required</mat-error>
        }
      </mat-form-field>
    </div>

    <!-- User Type Selection -->
    <div class="space-y-3 p-4 bg-gray-50 rounded-lg">
      <h4 class="text-sm font-medium text-gray-700 mb-3">I want to:</h4>
      <mat-radio-group 
        formControlName="userType" 
        class="radio-group-inline"
        [disabled]="loading()"
      >
        <div class="radio-options">
          <mat-radio-button value="buyer" class="radio-option">
            Find women-owned businesses
          </mat-radio-button>
          <mat-radio-button value="seller" class="radio-option">
            Offer services through my business
          </mat-radio-button>
        </div>
      </mat-radio-group>
      @if (userTypeControl?.invalid && userTypeControl?.touched) {
        <mat-error>Please select an option</mat-error>
      }
    </div>

    <!-- Email and Heritage -->
    <div class="grid grid-cols-2 gap-4">
      <mat-form-field appearance="outline">
        <mat-label>Email Address</mat-label>
        <input
          matInput
          type="email"
          formControlName="email"
          placeholder="your@email.com"
          [disabled]="loading()"
        />
        <mat-icon matSuffix>email</mat-icon>
        @if (emailControl?.invalid && emailControl?.touched) {
          <mat-error>
            @if (emailControl?.hasError('required')) {
              Email is required
            } @else if (emailControl?.hasError('email')) {
              Invalid email format
            }
          </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Heritage</mat-label>
        <mat-select
          formControlName="countryOfOrigin"
          [disabled]="loading()"
        >
          <mat-option value="">Select country</mat-option>
          @for (country of countries; track country.code) {
            <mat-option [value]="country.name">{{ country.name }}</mat-option>
          }
        </mat-select>
        <mat-icon matSuffix>public</mat-icon>
        @if (countryOfOriginControl?.invalid && countryOfOriginControl?.touched) {
          <mat-error>Required</mat-error>
        }
      </mat-form-field>
    </div>

    <!-- Password Field -->
    <mat-form-field appearance="outline">
      <mat-label>Password</mat-label>
      <input
        matInput
        [type]="showPassword() ? 'text' : 'password'"
        formControlName="password"
        placeholder="Enter password"
        [disabled]="loading()"
      />
      <button 
        mat-icon-button 
        matSuffix 
        type="button"
        (click)="togglePasswordVisibility()"
        [attr.aria-label]="'Toggle password visibility'"
        [attr.aria-pressed]="showPassword()"
      >
        <mat-icon>{{ showPassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
      </button>
      @if (passwordControl?.invalid && passwordControl?.touched) {
        <mat-error>
          @if (passwordControl?.hasError('required')) {
            Password is required
          } @else if (passwordControl?.hasError('minlength')) {
            Minimum 6 characters
          }
        </mat-error>
      }
    </mat-form-field>

    <!-- Messages -->
    @if (authMessage()) {
      <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
        <div class="flex items-center text-blue-700">
          <mat-icon class="mr-2 text-sm">info</mat-icon>
          <span class="text-sm">{{ authMessage() }}</span>
        </div>
      </div>
    }

    @if (error()) {
      <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
        <div class="flex items-center text-red-700">
          <mat-icon class="mr-2 text-sm">error</mat-icon>
          <span class="text-sm">{{ error() }}</span>
        </div>
      </div>
    }

    @if (successMessage()) {
      <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
        <div class="flex items-center text-green-700">
          <mat-icon class="mr-2 text-sm">check_circle</mat-icon>
          <span class="text-sm">{{ successMessage() }}</span>
        </div>
      </div>
    }

    <!-- Submit Button -->
    <button
      mat-raised-button
      color="primary"
      type="submit"
      class="w-full py-3 text-base font-medium mb-4"
      [disabled]="loading() || !signupForm.valid"
    >
      @if (!(loading())) {
        Create Account
      } @else {
        <span class="flex items-center justify-center gap-2">
          <mat-spinner diameter="16"></mat-spinner>
          Creating...
        </span>
      }
    </button>

    <!-- Navigation to Sign In -->
    <div class="mt-4 pt-4 border-t border-gray-200 text-center">
      <p class="text-sm text-gray-600">
        Already have an account? 
        <a 
          mat-button 
          color="primary"
          [routerLink]="['/auth/login']"
          class="text-sm font-medium ml-1"
        >
          Sign in
        </a>
      </p>
    </div>
  </form>
  }

  <!-- Email Verification Step -->
  @if (showVerificationStep()) {
    <div class="text-center space-y-6">
      <div class="mb-6">
        <mat-icon class="text-6xl text-blue-500 mb-4">email</mat-icon>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Check Your Email</h2>
        <p class="text-gray-600 mb-4">
          We've sent a verification link to:
        </p>
        <p class="text-lg font-medium text-gray-900 mb-4">{{ verificationEmail() }}</p>
        <p class="text-gray-600">
          Click the link in the email to verify your account and complete your registration.
        </p>
      </div>

      <!-- Messages -->
      @if (error()) {
        <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
          <div class="flex items-center text-red-700">
            <mat-icon class="mr-2 text-sm">error</mat-icon>
            <span class="text-sm">{{ error() }}</span>
          </div>
        </div>
      }

      @if (successMessage()) {
        <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
          <div class="flex items-center text-green-700">
            <mat-icon class="mr-2 text-sm">check_circle</mat-icon>
            <span class="text-sm">{{ successMessage() }}</span>
          </div>
        </div>
      }

      <!-- Action Buttons -->
      <div class="space-y-3">
        <button 
          mat-raised-button 
          color="accent"
          (click)="resendVerification()"
          [disabled]="loading()"
          class="w-full py-3 text-base font-medium"
        >
          @if (!loading()) {
            Resend Verification Email
          } @else {
            <span class="flex items-center justify-center gap-2">
              <mat-spinner diameter="16"></mat-spinner>
              Sending...
            </span>
          }
        </button>

        <button 
          mat-button 
          color="primary"
          [routerLink]="['/auth/login']"
          class="w-full py-3 text-base font-medium"
        >
          Back to Login
        </button>
      </div>

      <div class="mt-6 pt-4 border-t border-gray-200">
        <p class="text-sm text-gray-500">
          Didn't receive the email? Check your spam folder or try resending.
        </p>
      </div>
    </div>
  }
</div>
