<div class="reset-password-container">
  <!-- Loading Token Verification -->
  @if (verifyingToken()) {
    <div class="text-center space-y-4">
      <mat-spinner diameter="40"></mat-spinner>
      <p class="text-gray-600">Verifying reset token...</p>
    </div>
  }

  <!-- Invalid Token -->
  @if (!verifyingToken() && !tokenValid()) {
    <div class="text-center space-y-6">
      <div class="mb-6">
        <mat-icon class="text-6xl text-red-500 mb-4">error_outline</mat-icon>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Invalid Reset Link</h2>
        <p class="text-gray-600">{{ error() }}</p>
      </div>
      
      <button 
        mat-raised-button 
        color="primary"
        [routerLink]="['/auth/forgot-password']"
        class="w-full py-3 text-base font-medium"
      >
        Request New Reset Link
      </button>

      <div class="mt-4 pt-4 border-t border-gray-200">
        <p class="text-sm text-gray-600">
          Remember your password? 
          <a 
            mat-button 
            color="primary"
            [routerLink]="['/auth/login']"
            class="text-sm font-medium ml-1"
          >
            Back to Login
          </a>
        </p>
      </div>
    </div>
  }

  <!-- Valid Token - Reset Form -->
  @if (!verifyingToken() && tokenValid()) {
    <div class="reset-form-container">
      <div class="text-center mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Set New Password</h2>
        @if (userEmail()) {
          <p class="text-gray-600 mb-2">Resetting password for: <strong>{{ userEmail() }}</strong></p>
        }
        <p class="text-gray-600">Please enter your new password below.</p>
      </div>

      <form [formGroup]="resetPasswordForm" (ngSubmit)="onSubmit()" class="space-y-6">
        <!-- New Password Field -->
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>New Password</mat-label>
          <input 
            matInput 
            [type]="showPassword() ? 'text' : 'password'" 
            formControlName="newPassword"
            placeholder="Enter your new password"
            [disabled]="loading()"
          />
          <button 
            mat-icon-button 
            matSuffix 
            type="button"
            (click)="togglePasswordVisibility()"
            [attr.aria-label]="'Toggle password visibility'"
            [attr.aria-pressed]="showPassword()"
          >
            <mat-icon>{{ showPassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
          @if (newPasswordControl?.invalid && newPasswordControl?.touched) {
            <mat-error>
              @if (newPasswordControl?.hasError('required')) {
                New password is required
              } @else if (newPasswordControl?.hasError('minlength')) {
                Password must be at least 8 characters long
              } @else if (newPasswordControl?.hasError('pattern')) {
                Password must contain uppercase, lowercase, number, and special character
              }
            </mat-error>
          }
        </mat-form-field>

        <!-- Confirm Password Field -->
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Confirm New Password</mat-label>
          <input 
            matInput 
            [type]="showConfirmPassword() ? 'text' : 'password'" 
            formControlName="confirmPassword"
            placeholder="Confirm your new password"
            [disabled]="loading()"
          />
          <button 
            mat-icon-button 
            matSuffix 
            type="button"
            (click)="toggleConfirmPasswordVisibility()"
            [attr.aria-label]="'Toggle confirm password visibility'"
            [attr.aria-pressed]="showConfirmPassword()"
          >
            <mat-icon>{{ showConfirmPassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
          @if (confirmPasswordControl?.invalid && confirmPasswordControl?.touched) {
            <mat-error>
              @if (confirmPasswordControl?.hasError('required')) {
                Please confirm your password
              }
            </mat-error>
          }
          @if (resetPasswordForm.hasError('passwordMismatch') && confirmPasswordControl?.touched) {
            <mat-error>
              Passwords do not match
            </mat-error>
          }
        </mat-form-field>

        <!-- Password Requirements -->
        <div class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
          <h4 class="text-sm font-medium text-gray-700 mb-3">Password Requirements:</h4>
          <div class="space-y-2">
            <div class="flex items-center text-sm" [class.text-green-600]="hasMinLength()" [class.text-gray-500]="!hasMinLength()">
              <mat-icon class="text-sm mr-2">{{ hasMinLength() ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
              At least 8 characters long
            </div>
            <div class="flex items-center text-sm" [class.text-green-600]="hasUppercase()" [class.text-gray-500]="!hasUppercase()">
              <mat-icon class="text-sm mr-2">{{ hasUppercase() ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
              One uppercase letter
            </div>
            <div class="flex items-center text-sm" [class.text-green-600]="hasLowercase()" [class.text-gray-500]="!hasLowercase()">
              <mat-icon class="text-sm mr-2">{{ hasLowercase() ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
              One lowercase letter
            </div>
            <div class="flex items-center text-sm" [class.text-green-600]="hasNumber()" [class.text-gray-500]="!hasNumber()">
              <mat-icon class="text-sm mr-2">{{ hasNumber() ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
              One number
            </div>
            <div class="flex items-center text-sm" [class.text-green-600]="hasSpecialChar()" [class.text-gray-500]="!hasSpecialChar()">
              <mat-icon class="text-sm mr-2">{{ hasSpecialChar() ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
              One special character (&#64;$!%*?&)
            </div>
          </div>
        </div>

        <!-- Messages -->
        @if (error()) {
          <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
            <div class="flex items-center text-red-700">
              <mat-icon class="mr-2 text-sm">error</mat-icon>
              <span class="text-sm">{{ error() }}</span>
            </div>
          </div>
        }

        @if (successMessage()) {
          <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
            <div class="flex items-center text-green-700">
              <mat-icon class="mr-2 text-sm">check_circle</mat-icon>
              <span class="text-sm">{{ successMessage() }}</span>
            </div>
            <p class="text-sm text-green-600 mt-2">You will be redirected to login in a few seconds...</p>
          </div>
        }

        <!-- Submit Button -->
        <button 
          mat-raised-button 
          color="primary" 
          type="submit"
          class="w-full py-3 text-base font-medium mb-4"
          [disabled]="!isFormValid() || loading()"
        >
          @if (!(loading())) {
            Reset Password
          } @else {
            <span class="flex items-center justify-center gap-2">
              <mat-spinner diameter="16"></mat-spinner>
              Resetting Password...
            </span>
          }
        </button>

        <!-- Navigation -->
        <div class="space-y-3 text-center">
          <a 
            mat-button 
            color="primary"
            [routerLink]="['/auth/login']"
            class="text-sm"
          >
            Remember your password? Back to Login
          </a>

          <!-- Navigation to Sign Up -->
          <div class="mt-4 pt-4 border-t border-gray-200">
            <p class="text-sm text-gray-600">
              Don't have an account? 
              <a 
                mat-button 
                color="primary"
                [routerLink]="['/auth/signup']"
                class="text-sm font-medium ml-1"
              >
                Sign up
              </a>
            </p>
          </div>
        </div>
      </form>
    </div>
  }
</div>