import{a as m}from"./chunk-V2EJJXO4.js";import{Ba as u,W as n,Z as v,da as l,g as p,kd as g,o,p as d}from"./chunk-QKXNVIL2.js";import{d as r}from"./chunk-QEZ3K4DX.js";var F=class a{http=l(g);config=l(m);apiUrl=`${this.config.apiBaseUrl}/favorites`;userFavorites=u([]);loading=u(!1);favoritedBusinessIds=new p(new Set);constructor(){this.loadUserFavorites()}addToFavorites(s){return this.loading.set(!0),this.http.post(this.apiUrl,{business_id:s}).pipe(n(t=>{if(t.success){let e=this.userFavorites();this.userFavorites.set([...e,t.data]);let i=new Set(this.favoritedBusinessIds.value);i.add(s),this.favoritedBusinessIds.next(i)}this.loading.set(!1)}))}removeFromFavorites(s){return this.loading.set(!0),this.http.delete(`${this.apiUrl}/${s}`).pipe(n(t=>{if(t.success){let i=this.userFavorites().filter(f=>f.business_id!==s);this.userFavorites.set(i);let c=new Set(this.favoritedBusinessIds.value);c.delete(s),this.favoritedBusinessIds.next(c)}this.loading.set(!1)}))}getUserFavorites(){return this.http.get(this.apiUrl).pipe(n(s=>{if(s.success){this.userFavorites.set(s.data);let t=new Set(s.data.map(e=>typeof e.business_id=="string"?e.business_id:e.business_id._id));this.favoritedBusinessIds.next(t)}}))}getBusinessFavoritesCount(s){return this.http.get(`${this.config.apiBaseUrl}/businesses/${s}/favorites-count`)}isBusinessFavorited(s){return this.favoritedBusinessIds.asObservable().pipe(d(t=>t.has(s)))}getFavoritedBusinessIds(){return this.favoritedBusinessIds.asObservable()}addToFavoritesAsync(s){return r(this,null,function*(){let t=yield o(this.addToFavorites(s));if(!t.success)throw new Error(t.error||"Failed to add to favorites");return t.data})}removeFromFavoritesAsync(s){return r(this,null,function*(){let t=yield o(this.removeFromFavorites(s));if(!t.success)throw new Error(t.error||"Failed to remove from favorites")})}getUserFavoritesAsync(){return r(this,null,function*(){try{let s=yield o(this.getUserFavorites());if(!s.success)throw new Error(s.error||"Failed to load favorites");return s.data}catch(s){throw console.error("Error in getUserFavoritesAsync:",s),s}})}getBusinessFavoritesCountAsync(s){return r(this,null,function*(){let t=yield o(this.getBusinessFavoritesCount(s));if(!t.success)throw new Error(t.error||"Failed to load favorites count");return t.data.count})}loadUserFavorites(){return r(this,null,function*(){try{console.log("Loading user favorites..."),yield this.getUserFavoritesAsync(),console.log("User favorites loaded successfully")}catch(s){console.warn("Failed to load user favorites on initialization:",s)}})}refreshFavorites(){return r(this,null,function*(){yield this.loadUserFavorites()})}toggleFavorite(s){return r(this,null,function*(){return this.favoritedBusinessIds.value.has(s)?(yield this.removeFromFavoritesAsync(s),!1):(yield this.addToFavoritesAsync(s),!0)})}getFavoritesCount(){return this.userFavorites().length}getMultipleBusinessesFavoritesCount(s){return r(this,null,function*(){try{let t={};return yield Promise.all(s.map(e=>r(this,null,function*(){try{let i=yield this.getBusinessFavoritesCountAsync(e);t[e]=i}catch(i){console.warn(`Failed to get favorites count for business ${e}:`,i),t[e]=0}}))),t}catch(t){return console.error("Error getting multiple businesses favorites count:",t),{}}})}static \u0275fac=function(t){return new(t||a)};static \u0275prov=v({token:a,factory:a.\u0275fac,providedIn:"root"})};export{F as a};
