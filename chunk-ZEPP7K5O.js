import{a as F}from"./chunk-ZSXFIASO.js";import{B as p}from"./chunk-KJIZDUX4.js";import{$ as l,Ea as c,Y as n,fa as u,g as d,o,q as g}from"./chunk-OEBJLLDW.js";import{e as r}from"./chunk-JKOY2XUY.js";var h=class a{http=u(p);config=u(F);apiUrl=`${this.config.apiBaseUrl}/favorites`;userFavorites=c([]);loading=c(!1);favoritedBusinessIds=new d(new Set);constructor(){this.loadUserFavorites()}addToFavorites(s){return this.loading.set(!0),this.http.post(this.apiUrl,{business_id:s}).pipe(n(e=>{if(e.success){let t=this.userFavorites();this.userFavorites.set([...t,e.data]);let i=new Set(this.favoritedBusinessIds.value);i.add(s),this.favoritedBusinessIds.next(i)}this.loading.set(!1)}))}removeFromFavorites(s){return this.loading.set(!0),this.http.delete(`${this.apiUrl}/${s}`).pipe(n(e=>{if(e.success){let i=this.userFavorites().filter(f=>f.business_id!==s);this.userFavorites.set(i);let v=new Set(this.favoritedBusinessIds.value);v.delete(s),this.favoritedBusinessIds.next(v)}this.loading.set(!1)}))}getUserFavorites(){return this.http.get(this.apiUrl).pipe(n(s=>{if(s.success){this.userFavorites.set(s.data);let e=new Set(s.data.map(t=>typeof t.business_id=="string"?t.business_id:t.business_id._id));this.favoritedBusinessIds.next(e)}}))}getBusinessFavoritesCount(s){return this.http.get(`${this.config.apiBaseUrl}/businesses/${s}/favorites-count`)}isBusinessFavorited(s){return this.favoritedBusinessIds.asObservable().pipe(g(e=>e.has(s)))}getFavoritedBusinessIds(){return this.favoritedBusinessIds.asObservable()}addToFavoritesAsync(s){return r(this,null,function*(){let e=yield o(this.addToFavorites(s));if(!e.success)throw new Error(e.error||"Failed to add to favorites");return e.data})}removeFromFavoritesAsync(s){return r(this,null,function*(){let e=yield o(this.removeFromFavorites(s));if(!e.success)throw new Error(e.error||"Failed to remove from favorites")})}getUserFavoritesAsync(){return r(this,null,function*(){try{let s=yield o(this.getUserFavorites());if(!s.success)throw new Error(s.error||"Failed to load favorites");return s.data}catch(s){throw console.error("Error in getUserFavoritesAsync:",s),s}})}getBusinessFavoritesCountAsync(s){return r(this,null,function*(){let e=yield o(this.getBusinessFavoritesCount(s));if(!e.success)throw new Error(e.error||"Failed to load favorites count");return e.data.count})}loadUserFavorites(){return r(this,null,function*(){try{console.log("Loading user favorites..."),yield this.getUserFavoritesAsync(),console.log("User favorites loaded successfully")}catch(s){console.warn("Failed to load user favorites on initialization:",s)}})}refreshFavorites(){return r(this,null,function*(){yield this.loadUserFavorites()})}toggleFavorite(s){return r(this,null,function*(){return this.favoritedBusinessIds.value.has(s)?(yield this.removeFromFavoritesAsync(s),!1):(yield this.addToFavoritesAsync(s),!0)})}getFavoritesCount(){return this.userFavorites().length}getMultipleBusinessesFavoritesCount(s){return r(this,null,function*(){try{let e={};return yield Promise.all(s.map(t=>r(this,null,function*(){try{let i=yield this.getBusinessFavoritesCountAsync(t);e[t]=i}catch(i){console.warn(`Failed to get favorites count for business ${t}:`,i),e[t]=0}}))),e}catch(e){return console.error("Error getting multiple businesses favorites count:",e),{}}})}static \u0275fac=function(e){return new(e||a)};static \u0275prov=l({token:a,factory:a.\u0275fac,providedIn:"root"})};export{h as a};
