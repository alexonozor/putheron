import{a as F}from"./chunk-4GWWNNYU.js";import{a as m}from"./chunk-LDSTDJZ6.js";import{A as p}from"./chunk-FI3M32ZM.js";import{D as n,Y as u,aa as f,fa as c,g as l,k as o,o as a,q as h,ua as v}from"./chunk-M7BUBJMW.js";import{e as r}from"./chunk-JKOY2XUY.js";var b=class d{http=c(p);config=c(m);authService=c(F);apiUrl=`${this.config.apiBaseUrl}/favorites`;userFavorites=v([]);loading=v(!1);favoritedBusinessIds=new l(new Set);constructor(){this.authService.isAuthenticated()&&this.loadUserFavorites()}addToFavorites(e){return this.authService.isAuthenticated()?(this.loading.set(!0),this.http.post(this.apiUrl,{business_id:e}).pipe(u(s=>{if(s.success){let t=this.userFavorites();this.userFavorites.set([...t,s.data]);let i=new Set(this.favoritedBusinessIds.value);i.add(e),this.favoritedBusinessIds.next(i)}this.loading.set(!1)}),n(s=>(this.loading.set(!1),console.error("Error adding to favorites:",s),o({success:!1,data:{},error:s.message}))))):o({success:!1,data:{},error:"User must be authenticated to add favorites"})}removeFromFavorites(e){return this.authService.isAuthenticated()?(this.loading.set(!0),this.http.delete(`${this.apiUrl}/${e}`).pipe(u(s=>{if(s.success){let i=this.userFavorites().filter(y=>y.business_id!==e);this.userFavorites.set(i);let g=new Set(this.favoritedBusinessIds.value);g.delete(e),this.favoritedBusinessIds.next(g)}this.loading.set(!1)}),n(s=>(this.loading.set(!1),console.error("Error removing from favorites:",s),o({success:!1,data:{message:""},error:s.message}))))):o({success:!1,data:{message:""},error:"User must be authenticated to remove favorites"})}getUserFavorites(){return this.authService.isAuthenticated()?this.http.get(this.apiUrl).pipe(u(e=>{if(e.success){this.userFavorites.set(e.data);let s=new Set(e.data.map(t=>typeof t.business_id=="string"?t.business_id:t.business_id._id));this.favoritedBusinessIds.next(s)}}),n(e=>(console.error("Error fetching favorites:",e),o({success:!1,data:[],error:e.message})))):o({success:!0,data:[]})}getBusinessFavoritesCount(e){return this.http.get(`${this.config.apiBaseUrl}/businesses/${e}/favorites-count`)}isBusinessFavorited(e){return this.favoritedBusinessIds.asObservable().pipe(h(s=>s.has(e)))}getFavoritedBusinessIds(){return this.favoritedBusinessIds.asObservable()}addToFavoritesAsync(e){return r(this,null,function*(){let s=yield a(this.addToFavorites(e));if(!s.success)throw new Error(s.error||"Failed to add to favorites");return s.data})}removeFromFavoritesAsync(e){return r(this,null,function*(){let s=yield a(this.removeFromFavorites(e));if(!s.success)throw new Error(s.error||"Failed to remove from favorites")})}getUserFavoritesAsync(){return r(this,null,function*(){try{let e=yield a(this.getUserFavorites());if(!e.success)throw new Error(e.error||"Failed to load favorites");return e.data}catch(e){throw console.error("Error in getUserFavoritesAsync:",e),e}})}getBusinessFavoritesCountAsync(e){return r(this,null,function*(){let s=yield a(this.getBusinessFavoritesCount(e));if(!s.success)throw new Error(s.error||"Failed to load favorites count");return s.data.count})}loadUserFavorites(){return r(this,null,function*(){if(!this.authService.isAuthenticated()){console.log("User not authenticated, skipping favorites load");return}try{console.log("Loading user favorites..."),yield this.getUserFavoritesAsync(),console.log("User favorites loaded successfully")}catch(e){console.warn("Failed to load user favorites on initialization:",e)}})}refreshFavorites(){return r(this,null,function*(){yield this.loadUserFavorites()})}toggleFavorite(e){return r(this,null,function*(){return this.favoritedBusinessIds.value.has(e)?(yield this.removeFromFavoritesAsync(e),!1):(yield this.addToFavoritesAsync(e),!0)})}getFavoritesCount(){return this.userFavorites().length}getMultipleBusinessesFavoritesCount(e){return r(this,null,function*(){try{let s={};return yield Promise.all(e.map(t=>r(this,null,function*(){try{let i=yield this.getBusinessFavoritesCountAsync(t);s[t]=i}catch(i){console.warn(`Failed to get favorites count for business ${t}:`,i),s[t]=0}}))),s}catch(s){return console.error("Error getting multiple businesses favorites count:",s),{}}})}static \u0275fac=function(s){return new(s||d)};static \u0275prov=f({token:d,factory:d.\u0275fac,providedIn:"root"})};export{b as a};
