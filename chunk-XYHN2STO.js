import{a as m}from"./chunk-GS6LNAK5.js";import{B as _}from"./chunk-REOVWAHI.js";import{$ as l,Ea as E,fa as p,o as d}from"./chunk-BEPULU6C.js";import{a as r,b as c,e as s}from"./chunk-JKOY2XUY.js";var h=class u{http=p(_);config=p(m);notifications=E([]);unreadCount=E(0);isLoading=E(!1);notificationAudio;constructor(){this.initializeNotificationSound()}initializeNotificationSound(){this.notificationAudio=new Audio,this.notificationAudio.src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+T5u20e",this.notificationAudio.volume=.5}getApiUrl(t){return this.config.getApiUrl(`notifications${t}`)}getNotifications(){return s(this,arguments,function*(t={}){this.isLoading.set(!0);try{let i=new URLSearchParams;t.type&&i.append("type",t.type),t.is_read!==void 0&&i.append("is_read",t.is_read.toString()),t.is_seen!==void 0&&i.append("is_seen",t.is_seen.toString()),t.page&&i.append("page",t.page.toString()),t.limit&&i.append("limit",t.limit.toString());let o=this.getApiUrl(`?${i.toString()}`),e=yield d(this.http.get(o));if(e.success)return this.notifications.set(e.data),this.unreadCount.set(e.meta.unreadCount),{notifications:e.data,total:e.meta.total,unreadCount:e.meta.unreadCount,page:e.meta.page,limit:e.meta.limit};throw new Error(e.message||"Failed to fetch notifications")}finally{this.isLoading.set(!1)}})}getUnreadCount(){return s(this,null,function*(){try{let t=yield d(this.http.get(this.getApiUrl("/unread-count")));if(t.success)return this.unreadCount.set(t.data.count),t.data.count;throw new Error(t.message||"Failed to fetch unread count")}catch(t){return console.error("Error fetching unread count:",t),0}})}markAsRead(t){return s(this,null,function*(){try{let i=yield d(this.http.patch(this.getApiUrl(`/${t}/read`),{}));if(i.success){let e=this.notifications().map(a=>a._id===t?c(r({},a),{is_read:!0,read_at:new Date}):a);this.notifications.set(e);let n=this.unreadCount();return this.unreadCount.set(Math.max(0,n-1)),i.data}throw new Error(i.message||"Failed to mark notification as read")}catch(i){if(i.status===0||i.message?.includes("CORS")){console.warn("CORS error when marking notification as read. Updating local state anyway.");let o=this.notifications(),e=o.find(n=>n._id===t);if(e&&!e.is_read){let n=o.map(f=>f._id===t?c(r({},f),{is_read:!0,read_at:new Date}):f);this.notifications.set(n);let a=this.unreadCount();this.unreadCount.set(Math.max(0,a-1))}return e}else throw i}})}markAsSeen(t){return s(this,null,function*(){let i=yield d(this.http.patch(this.getApiUrl(`/${t}/seen`),{}));if(i.success){let e=this.notifications().map(n=>n._id===t?c(r({},n),{is_seen:!0,seen_at:new Date}):n);return this.notifications.set(e),i.data}throw new Error(i.message||"Failed to mark notification as seen")})}markAllAsRead(){return s(this,null,function*(){try{let t=yield d(this.http.patch(this.getApiUrl("/mark-all-read"),{}));if(t.success){let o=this.notifications().map(e=>c(r({},e),{is_read:!0,read_at:new Date}));this.notifications.set(o),this.unreadCount.set(0)}else throw new Error(t.message||"Failed to mark all notifications as read")}catch(t){if(t.status===0||t.message?.includes("CORS")){console.warn("CORS error when marking notifications as read. Updating local state anyway.");let o=this.notifications().map(e=>c(r({},e),{is_read:!0,read_at:new Date}));this.notifications.set(o),this.unreadCount.set(0),console.log("Notification read status updated locally. Changes will sync when connection is restored.")}else throw t}})}markAllAsSeen(){return s(this,null,function*(){try{let t=yield d(this.http.patch(this.getApiUrl("/mark-all-seen"),{}));if(t.success){let o=this.notifications().map(e=>c(r({},e),{is_seen:!0,seen_at:new Date}));this.notifications.set(o)}else throw new Error(t.message||"Failed to mark all notifications as seen")}catch(t){if(t.status===0||t.message?.includes("CORS")){console.warn("CORS error when marking notifications as seen. This is non-critical for UX.");let o=this.notifications().map(e=>c(r({},e),{is_seen:!0,seen_at:new Date}));this.notifications.set(o)}else throw t}})}deleteNotification(t){return s(this,null,function*(){let i=yield d(this.http.delete(this.getApiUrl(`/${t}`)));if(i.success){let o=this.notifications(),e=o.filter(a=>a._id!==t);this.notifications.set(e);let n=o.find(a=>a._id===t);if(n&&!n.is_read){let a=this.unreadCount();this.unreadCount.set(Math.max(0,a-1))}}else throw new Error(i.message||"Failed to delete notification")})}handleNewNotification(t){let i=this.notifications();if(i.find(e=>e._id===t._id)){console.log("Notification already exists, skipping duplicate:",t._id);return}if(this.notifications.set([t,...i]),!t.is_read){let e=this.unreadCount();this.unreadCount.set(e+1)}this.playNotificationSound(),this.updatePageTitle(),this.showBrowserNotification(t)}handleUnreadCountUpdate(t){this.unreadCount.set(t)}playNotificationSound(){this.notificationAudio&&(this.notificationAudio.currentTime=0,this.notificationAudio.play().catch(t=>{console.warn("Could not play notification sound:",t)}))}updatePageTitle(){let t=this.unreadCount(),i=document.title.replace(/^\(\d+\)\s/,"");t>0?document.title=`(${t}) ${i}`:document.title=i}showBrowserNotification(t){if("Notification"in window&&Notification.permission==="granted"){let i=new Notification(t.title,{body:t.message,icon:"/favicon.ico",badge:"/favicon.ico"});i.onclick=()=>{window.focus(),i.close()},setTimeout(()=>{i.close()},5e3)}}requestNotificationPermission(){return s(this,null,function*(){return"Notification"in window?yield Notification.requestPermission():"denied"})}getNotificationIcon(t){return{project_created:"\u{1F4CB}",project_accepted:"\u2705",project_rejected:"\u274C",project_started:"\u{1F680}",project_completed:"\u{1F389}",project_completed_by_business:"\u{1F4CB}",project_completion_approved:"\u2705",project_completion_rejected:"\u274C",additional_payment_requested:"\u{1F4B3}",additional_payment_approved:"\u2705",additional_payment_rejected:"\u274C",additional_payment_completed:"\u{1F4B0}",business_approved:"\u2705",business_rejected:"\u274C",business_suspended:"\u26A0\uFE0F",business_reactivated:"\u2705",review_received:"\u2B50",review_replied:"\u{1F4AC}",payment_request:"\u{1F4B3}",payment_approved:"\u2705",payment_rejected:"\u274C",completion_request:"\u{1F4DD}",completion_approved:"\u2705",completion_rejected:"\u274C",promotion:"\u{1F38A}",system_announcement:"\u{1F4E2}",message_received:"\u{1F4AC}"}[t]||"\u{1F514}"}getNotificationColor(t){let i={low:"bg-gray-100 border-gray-300",medium:"bg-blue-50 border-blue-300",high:"bg-orange-50 border-orange-300",urgent:"bg-red-50 border-red-300"};return i[t]||i.medium}formatTimeAgo(t){try{let i=new Date,o=new Date(t);if(isNaN(o.getTime()))return"recently";let e=Math.floor((i.getTime()-o.getTime())/1e3);return e<60?"just now":e<3600?`${Math.floor(e/60)}m ago`:e<86400?`${Math.floor(e/3600)}h ago`:e<604800?`${Math.floor(e/86400)}d ago`:o.toLocaleDateString()}catch(i){return console.error("Error formatting date:",i,"Date value:",t),"recently"}}static \u0275fac=function(i){return new(i||u)};static \u0275prov=l({token:u,factory:u.\u0275fac,providedIn:"root"})};export{h as a};
