import{a as _}from"./chunk-MPWT2TAC.js";import{B as P}from"./chunk-VT4ZEATH.js";import{$ as u,Ea as E,Oc as n,fa as d,g as l,q as c}from"./chunk-ZABOWSPW.js";import{e as m}from"./chunk-JKOY2XUY.js";var g=class a{http=d(P);config=d(_);userPermissionsSubject=new l(null);loadingSubject=new l(!1);userPermissions=E(null);isLoading=E(!1);allPermissions=n(()=>this.userPermissions()?.allPermissions||[]);permissionNames=n(()=>this.allPermissions().map(s=>s.name));activeRoles=n(()=>{let s=this.userPermissions();return s?s.roles.filter(e=>e.is_active?e.expires_at?new Date(e.expires_at)>new Date:!0:!1):[]});userPermissions$=this.userPermissionsSubject.asObservable();isLoading$=this.loadingSubject.asObservable();constructor(){this.userPermissionsSubject.subscribe(s=>{this.userPermissions.set(s),this.persistPermissions(s)}),this.loadingSubject.subscribe(s=>{this.isLoading.set(s)}),this.restorePermissions()}getApiUrl(s){return this.config.getApiUrl(`/admin/roles${s}`)}loadUserPermissions(s){return m(this,null,function*(){try{this.loadingSubject.next(!0),console.log("Loading permissions for user:",s);try{let[e,r]=yield Promise.all([this.http.get(this.getApiUrl(`/users/${s}/roles`)).toPromise(),this.http.get(this.getApiUrl(`/users/${s}/permissions`)).toPromise()]);if(e?.success&&r?.success){let i={userId:s,roles:e.data.map(o=>({_id:o.role_id._id||o.role_id,name:o.role_id.name||"unknown",display_name:o.role_id.display_name,permissions:o.role_id.permissions||[],is_active:o.is_active,expires_at:o.expires_at})),directPermissions:[],allPermissions:r.data};console.log("Loaded user permissions from admin API:",i),this.userPermissionsSubject.next(i);return}}catch(e){if(console.warn("Failed to load from admin API (likely permission issue):",e.status),e.status===403){console.log("User does not have admin access, creating basic permissions structure");let r={userId:s,roles:[],directPermissions:[],allPermissions:[]};console.log("Created basic permissions for non-admin user:",r),this.userPermissionsSubject.next(r);return}throw e}console.error("Admin API returned invalid responses"),this.userPermissionsSubject.next(null)}catch(e){console.error("Error loading user permissions:",e),this.userPermissionsSubject.next(null)}finally{this.loadingSubject.next(!1)}})}hasPermission(s){return this.permissionNames().includes(s)}hasAnyPermission(s){let e=this.permissionNames();return s.some(r=>e.includes(r))}hasAllPermissions(s){let e=this.permissionNames();return s.every(r=>e.includes(r))}hasRole(s){return this.activeRoles().some(r=>r.name===s||r.display_name===s)}hasAnyRole(s){let e=this.activeRoles();return s.some(r=>e.some(i=>i.name===r||i.display_name===r))}checkPermissions(s){return s.every(e=>{if(typeof e.permission=="string")return this.hasPermission(e.permission);let r=Array.isArray(e.permission)?e.permission:[e.permission];return e.requireAll?this.hasAllPermissions(r):this.hasAnyPermission(r)})}canAccess(s,e){let r=e?`${s}.${e}`:s;return this.hasPermission(r)}hasPermission$(s){return this.userPermissions$.pipe(c(e=>e?e.allPermissions.some(r=>r.name===s):!1))}hasRole$(s){return this.userPermissions$.pipe(c(e=>e?e.roles.some(r=>(r.name===s||r.display_name===s)&&r.is_active&&(!r.expires_at||new Date(r.expires_at)>new Date)):!1))}getPermissionsByCategory(){let s=this.allPermissions(),e={};return s.forEach(r=>{let i=r.category||"General";e[i]||(e[i]=[]),e[i].push(r)}),e}persistPermissions(s){if(!(typeof window>"u"||!localStorage))try{s?(localStorage.setItem("userPermissions",JSON.stringify(s)),localStorage.setItem("permissionsTimestamp",Date.now().toString()),console.log("Permissions persisted to localStorage")):(localStorage.removeItem("userPermissions"),localStorage.removeItem("permissionsTimestamp"),console.log("Permissions cleared from localStorage"))}catch(e){console.warn("Failed to persist permissions to localStorage:",e)}}restorePermissions(){if(!(typeof window>"u"||!localStorage))try{let s=localStorage.getItem("userPermissions"),e=localStorage.getItem("permissionsTimestamp");if(s&&e){let r=Date.now()-parseInt(e),i=24*60*60*1e3;if(r<i){let o=JSON.parse(s);console.log("Restored permissions from localStorage:",o),this.userPermissionsSubject.next(o);return}else console.log("Stored permissions are too old, clearing them"),this.clearStoredPermissions()}else console.log("No stored permissions found in localStorage")}catch(s){console.warn("Failed to restore permissions from localStorage:",s),this.clearStoredPermissions()}}clearStoredPermissions(){localStorage.removeItem("userPermissions"),localStorage.removeItem("permissionsTimestamp")}clearPermissions(){this.userPermissionsSubject.next(null),this.clearStoredPermissions()}refreshPermissions(s){return m(this,null,function*(){yield this.loadUserPermissions(s)})}hasAdminAccess=n(()=>{let s=this.permissionNames(),e=this.activeRoles(),r=["super_admin","admin","system_admin","moderator"],i=e.some(t=>r.includes(t.name.toLowerCase())||r.includes(t.display_name?.toLowerCase()||"")),p=["dashboard.read","users.read","users.create","users.update","users.delete","businesses.read","businesses.approve","businesses.suspend","services.read","services.approve","services.reject","categories.read","categories.create","categories.update","projects.read","projects.approve","projects.reject","reviews.read","reviews.moderate","reviews.flag","transactions.read","transactions.refund","transactions.cancel","reports.read","analytics.read","roles.read","roles.create","roles.update","roles.delete","permissions.read","permissions.create","permissions.update","settings.read","audit.read"].some(t=>s.includes(t)),S=i||p;return console.log("Admin access check:",{permissions:s.length,roles:e.map(t=>t.name),hasAdminRole:i,hasAdminPermission:p,hasAccess:S}),S});static PERMISSIONS={USERS_VIEW:"users.read",USERS_CREATE:"users.create",USERS_EDIT:"users.update",USERS_DELETE:"users.delete",USERS_SUSPEND:"users.suspend",USERS_EXPORT:"users.export",BUSINESS_VIEW:"businesses.read",BUSINESS_CREATE:"businesses.create",BUSINESS_EDIT:"businesses.update",BUSINESS_DELETE:"businesses.delete",BUSINESS_APPROVE:"businesses.approve",BUSINESS_REJECT:"businesses.reject",BUSINESS_SUSPEND:"businesses.suspend",BUSINESS_EXPORT:"businesses.export",SERVICES_VIEW:"services.read",SERVICES_CREATE:"services.create",SERVICES_EDIT:"services.update",SERVICES_DELETE:"services.delete",SERVICES_APPROVE:"services.approve",SERVICES_REJECT:"services.reject",SERVICES_EXPORT:"services.export",CATEGORIES_VIEW:"categories.read",CATEGORIES_CREATE:"categories.create",CATEGORIES_EDIT:"categories.update",CATEGORIES_DELETE:"categories.delete",CATEGORIES_REORDER:"categories.reorder",CATEGORIES_EXPORT:"categories.export",PROJECTS_VIEW:"projects.read",PROJECTS_CREATE:"projects.create",PROJECTS_EDIT:"projects.update",PROJECTS_DELETE:"projects.delete",PROJECTS_APPROVE:"projects.approve",PROJECTS_REJECT:"projects.reject",PROJECTS_EXPORT:"projects.export",REVIEWS_VIEW:"reviews.read",REVIEWS_CREATE:"reviews.create",REVIEWS_EDIT:"reviews.update",REVIEWS_DELETE:"reviews.delete",REVIEWS_MODERATE:"reviews.moderate",REVIEWS_FLAG:"reviews.flag",REVIEWS_EXPORT:"reviews.export",TRANSACTIONS_VIEW:"transactions.read",TRANSACTIONS_CREATE:"transactions.create",TRANSACTIONS_EDIT:"transactions.update",TRANSACTIONS_DELETE:"transactions.delete",TRANSACTIONS_REFUND:"transactions.refund",TRANSACTIONS_CANCEL:"transactions.cancel",TRANSACTIONS_EXPORT:"transactions.export",REPORTS_VIEW:"reports.read",REPORTS_CREATE:"reports.create",REPORTS_EDIT:"reports.update",REPORTS_DELETE:"reports.delete",REPORTS_EXPORT:"reports.export",ANALYTICS_VIEW:"analytics.read",ANALYTICS_ADVANCED:"analytics.advanced",ROLES_VIEW:"roles.read",ROLES_CREATE:"roles.create",ROLES_EDIT:"roles.update",ROLES_DELETE:"roles.delete",ROLES_ASSIGN:"roles.assign",PERMISSIONS_VIEW:"permissions.read",PERMISSIONS_CREATE:"permissions.create",PERMISSIONS_EDIT:"permissions.update",PERMISSIONS_DELETE:"permissions.delete",ADMIN_ACCESS:"dashboard.read",ADMIN_DASHBOARD:"dashboard.read",SETTINGS_VIEW:"settings.read",SETTINGS_EDIT:"settings.update",AUDIT_VIEW:"audit.read",AUDIT_EXPORT:"audit.export",BUSINESS_MANAGE:"businesses.update",USERS_MANAGE:"users.update"};static ROLES={SUPER_ADMIN:"super_admin",ADMIN:"admin",MODERATOR:"moderator",USER:"user",BUSINESS_OWNER:"business_owner",BUSINESS_MANAGER:"business_manager"};static \u0275fac=function(e){return new(e||a)};static \u0275prov=u({token:a,factory:a.\u0275fac,providedIn:"root"})};export{g as a};
