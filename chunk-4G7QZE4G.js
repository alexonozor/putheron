import{a as g}from"./chunk-7XH4VAXZ.js";import{O as l,S as p,ha as f,kc as m,l as r}from"./chunk-YOTEMOQK.js";import{a as c,b as d,d as a}from"./chunk-QEZ3K4DX.js";var E=class u{http=p(m);config=p(g);notifications=f([]);unreadCount=f(0);isLoading=f(!1);notificationAudio;constructor(){this.initializeNotificationSound()}initializeNotificationSound(){this.notificationAudio=new Audio,this.notificationAudio.src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+T5u20e",this.notificationAudio.volume=.5}getApiUrl(t){return this.config.getApiUrl(`notifications${t}`)}getNotifications(){return a(this,arguments,function*(t={}){this.isLoading.set(!0);try{let i=new URLSearchParams;t.type&&i.append("type",t.type),t.is_read!==void 0&&i.append("is_read",t.is_read.toString()),t.is_seen!==void 0&&i.append("is_seen",t.is_seen.toString()),t.page&&i.append("page",t.page.toString()),t.limit&&i.append("limit",t.limit.toString());let o=this.getApiUrl(`?${i.toString()}`),e=yield r(this.http.get(o));if(e.success)return this.notifications.set(e.data),this.unreadCount.set(e.meta.unreadCount),{notifications:e.data,total:e.meta.total,unreadCount:e.meta.unreadCount,page:e.meta.page,limit:e.meta.limit};throw new Error(e.message||"Failed to fetch notifications")}finally{this.isLoading.set(!1)}})}getUnreadCount(){return a(this,null,function*(){try{let t=yield r(this.http.get(this.getApiUrl("/unread-count")));if(t.success)return this.unreadCount.set(t.data.count),t.data.count;throw new Error(t.message||"Failed to fetch unread count")}catch(t){return console.error("Error fetching unread count:",t),0}})}markAsRead(t){return a(this,null,function*(){let i=yield r(this.http.patch(this.getApiUrl(`/${t}/read`),{}));if(i.success){let e=this.notifications().map(n=>n._id===t?d(c({},n),{is_read:!0,read_at:new Date}):n);this.notifications.set(e);let s=this.unreadCount();return this.unreadCount.set(Math.max(0,s-1)),i.data}throw new Error(i.message||"Failed to mark notification as read")})}markAsSeen(t){return a(this,null,function*(){let i=yield r(this.http.patch(this.getApiUrl(`/${t}/seen`),{}));if(i.success){let e=this.notifications().map(s=>s._id===t?d(c({},s),{is_seen:!0,seen_at:new Date}):s);return this.notifications.set(e),i.data}throw new Error(i.message||"Failed to mark notification as seen")})}markAllAsRead(){return a(this,null,function*(){let t=yield r(this.http.patch(this.getApiUrl("/mark-all-read"),{}));if(t.success){let o=this.notifications().map(e=>d(c({},e),{is_read:!0,read_at:new Date}));this.notifications.set(o),this.unreadCount.set(0)}else throw new Error(t.message||"Failed to mark all notifications as read")})}markAllAsSeen(){return a(this,null,function*(){let t=yield r(this.http.patch(this.getApiUrl("/mark-all-seen"),{}));if(t.success){let o=this.notifications().map(e=>d(c({},e),{is_seen:!0,seen_at:new Date}));this.notifications.set(o)}else throw new Error(t.message||"Failed to mark all notifications as seen")})}deleteNotification(t){return a(this,null,function*(){let i=yield r(this.http.delete(this.getApiUrl(`/${t}`)));if(i.success){let o=this.notifications(),e=o.filter(n=>n._id!==t);this.notifications.set(e);let s=o.find(n=>n._id===t);if(s&&!s.is_read){let n=this.unreadCount();this.unreadCount.set(Math.max(0,n-1))}}else throw new Error(i.message||"Failed to delete notification")})}handleNewNotification(t){let i=this.notifications();if(i.find(e=>e._id===t._id)){console.log("Notification already exists, skipping duplicate:",t._id);return}if(this.notifications.set([t,...i]),!t.is_read){let e=this.unreadCount();this.unreadCount.set(e+1)}this.playNotificationSound(),this.updatePageTitle(),this.showBrowserNotification(t)}handleUnreadCountUpdate(t){this.unreadCount.set(t)}playNotificationSound(){this.notificationAudio&&(this.notificationAudio.currentTime=0,this.notificationAudio.play().catch(t=>{console.warn("Could not play notification sound:",t)}))}updatePageTitle(){let t=this.unreadCount(),i=document.title.replace(/^\(\d+\)\s/,"");t>0?document.title=`(${t}) ${i}`:document.title=i}showBrowserNotification(t){if("Notification"in window&&Notification.permission==="granted"){let i=new Notification(t.title,{body:t.message,icon:"/favicon.ico",badge:"/favicon.ico"});i.onclick=()=>{window.focus(),i.close()},setTimeout(()=>{i.close()},5e3)}}requestNotificationPermission(){return a(this,null,function*(){return"Notification"in window?yield Notification.requestPermission():"denied"})}getNotificationIcon(t){return{project_created:"\u{1F4CB}",project_accepted:"\u2705",project_rejected:"\u274C",project_started:"\u{1F680}",project_completed:"\u{1F389}",payment_request:"\u{1F4B3}",payment_approved:"\u2705",payment_rejected:"\u274C",completion_request:"\u{1F4DD}",completion_approved:"\u2705",completion_rejected:"\u274C",promotion:"\u{1F38A}",system_announcement:"\u{1F4E2}",message_received:"\u{1F4AC}"}[t]||"\u{1F514}"}getNotificationColor(t){let i={low:"bg-gray-100 border-gray-300",medium:"bg-blue-50 border-blue-300",high:"bg-orange-50 border-orange-300",urgent:"bg-red-50 border-red-300"};return i[t]||i.medium}formatTimeAgo(t){try{let i=new Date,o=new Date(t);if(isNaN(o.getTime()))return"recently";let e=Math.floor((i.getTime()-o.getTime())/1e3);return e<60?"just now":e<3600?`${Math.floor(e/60)}m ago`:e<86400?`${Math.floor(e/3600)}h ago`:e<604800?`${Math.floor(e/86400)}d ago`:o.toLocaleDateString()}catch(i){return console.error("Error formatting date:",i,"Date value:",t),"recently"}}static \u0275fac=function(i){return new(i||u)};static \u0275prov=l({token:u,factory:u.\u0275fac,providedIn:"root"})};export{E as a};
