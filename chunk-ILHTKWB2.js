import{a as Be}from"./chunk-WLNORBSV.js";import{a as Ue,b as Ge,c as Le}from"./chunk-4W6YSKPS.js";import{a as Ve}from"./chunk-WNE6W2TF.js";import{a as B,b as K,e as Y,f as Z,g as ee,h as z}from"./chunk-EOSAMZE4.js";import{d as ae,h as G,i as se,j as le,l as H,m as L}from"./chunk-66HTC5NI.js";import{d as V,e as X,f as $e,k as U}from"./chunk-67MRJSI2.js";import{a as me,b as ce}from"./chunk-F52GGYS4.js";import{B as $,c as J,e as y,h as O,i as q,l as T,m as Ae,p as A,r as k,w as ke,x as Ne,z as N}from"./chunk-6HVQSJLB.js";import{c as j,d as D}from"./chunk-CAUPKMHV.js";import{s as R,t as F}from"./chunk-EZYZDCTR.js";import{a as Te}from"./chunk-LIZM4CZI.js";import{a as qe}from"./chunk-QD7SSFII.js";import{A as Oe,k as Q,t as I}from"./chunk-Z5YYMG7R.js";import{Da as Pe,Eb as C,Fb as x,Hb as we,Ib as fe,Jb as ye,Kb as d,Lb as a,Mb as i,Nb as h,Ub as W,Wc as De,Yb as _,_a as l,_b as f,aa as oe,cc as Ee,db as Se,dc as Ie,ec as Re,fa as p,jb as re,ka as M,kc as Fe,la as P,mc as s,nc as he,o as g,oc as v,pb as w,ua as S,vb as E,xc as je}from"./chunk-ME5BD2TS.js";import{e as m}from"./chunk-JKOY2XUY.js";var de=class r{http=p(Oe);configService=p(Te);get apiUrl(){return this.configService.getApiUrl("/chat")}createOrGetChat(e){return this.http.post(this.apiUrl,e)}createOrGetChatAsync(e){return m(this,null,function*(){return(yield g(this.createOrGetChat(e))).data})}getUserChats(){return this.http.get(this.apiUrl)}getUserChatsAsync(){return m(this,null,function*(){return(yield g(this.getUserChats())).data})}getChatById(e){return this.http.get(`${this.apiUrl}/${e}`)}getChatByIdAsync(e){return m(this,null,function*(){return(yield g(this.getChatById(e))).data})}getChatMessages(e,t=1,n=50){return this.http.get(`${this.apiUrl}/${e}/messages?page=${t}&limit=${n}`)}getChatMessagesAsync(e,t=1,n=50){return m(this,null,function*(){return(yield g(this.getChatMessages(e,t,n))).data})}sendMessage(e,t){return this.http.post(`${this.apiUrl}/${e}/messages`,t)}sendMessageAsync(e,t){return m(this,null,function*(){return(yield g(this.sendMessage(e,t))).data})}updateMessage(e,t,n){return this.http.patch(`${this.apiUrl}/${e}/messages/${t}`,n)}updateMessageAsync(e,t,n){return m(this,null,function*(){return(yield g(this.updateMessage(e,t,n))).data})}deleteMessage(e,t){return this.http.delete(`${this.apiUrl}/${e}/messages/${t}`)}deleteMessageAsync(e,t){return m(this,null,function*(){yield g(this.deleteMessage(e,t))})}markMessagesAsRead(e){return this.http.post(`${this.apiUrl}/${e}/mark-read`,{})}markMessagesAsReadAsync(e){return m(this,null,function*(){yield g(this.markMessagesAsRead(e))})}getUnreadMessageCount(){return this.http.get(`${this.apiUrl}/unread-count`)}getUnreadMessageCountAsync(){return m(this,null,function*(){return(yield g(this.getUnreadMessageCount())).data.count})}getChatByProjectId(e){return this.http.get(`${this.apiUrl}/project/${e}`)}getChatByProjectIdAsync(e){return m(this,null,function*(){return(yield g(this.getChatByProjectId(e))).data})}getChatUnreadCount(e){return this.http.get(`${this.apiUrl}/${e}/unread-count`)}getChatUnreadCountAsync(e){return m(this,null,function*(){return(yield g(this.getChatUnreadCount(e))).data.count})}uploadChatFiles(e,t,n){let o=new FormData;return t.forEach(c=>{o.append("files",c)}),n&&o.append("content",n),this.http.post(`${this.apiUrl}/${e}/upload-files`,o)}uploadChatFilesAsync(e,t,n){return m(this,null,function*(){return(yield g(this.uploadChatFiles(e,t,n))).data})}requestAdditionalPayment(e,t){return this.http.post(`${this.apiUrl}/${e}/request-payment`,t)}requestAdditionalPaymentAsync(e,t){return m(this,null,function*(){return(yield g(this.requestAdditionalPayment(e,t))).data})}respondToPaymentRequest(e,t,n){return this.http.post(`${this.apiUrl}/${e}/respond-payment/${t}`,n)}respondToPaymentRequestAsync(e,t,n){return m(this,null,function*(){return(yield g(this.respondToPaymentRequest(e,t,n))).data})}createAdditionalPaymentIntent(e,t){return this.http.post(`${this.apiUrl}/${e}/payment-intent/${t}`,{})}createAdditionalPaymentIntentAsync(e,t){return m(this,null,function*(){return(yield g(this.createAdditionalPaymentIntent(e,t))).data})}confirmAdditionalPayment(e,t,n){return this.http.post(`${this.apiUrl}/${e}/confirm-additional-payment/${t}`,{paymentIntentId:n})}confirmAdditionalPaymentAsync(e,t,n){return m(this,null,function*(){return(yield g(this.confirmAdditionalPayment(e,t,n))).data})}requestCompletion(e,t){return this.http.post(`${this.apiUrl}/${e}/request-completion`,t)}requestCompletionAsync(e,t){return m(this,null,function*(){return(yield g(this.requestCompletion(e,t))).data})}respondToCompletionRequest(e,t,n){return this.http.post(`${this.apiUrl}/${e}/respond-completion/${t}`,n)}respondToCompletionRequestAsync(e,t,n){return m(this,null,function*(){return(yield g(this.respondToCompletionRequest(e,t,n))).data})}static \u0275fac=function(t){return new(t||r)};static \u0275prov=oe({token:r,factory:r.\u0275fac,providedIn:"root"})};var Qe="basil",rt=function(e){return e===3?"v3":e},Je="https://js.stripe.com",at="".concat(Je,"/").concat(Qe,"/stripe.js"),st=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,lt=/^https:\/\/js\.stripe\.com\/(v3|[a-z]+)\/stripe\.js(\?.*)?$/,ze="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",mt=function(e){return st.test(e)||lt.test(e)},ct=function(){for(var e=document.querySelectorAll('script[src^="'.concat(Je,'"]')),t=0;t<e.length;t++){var n=e[t];if(mt(n.src))return n}return null},We=function(e){var t=e&&!e.advancedFraudSignals?"?advancedFraudSignals=false":"",n=document.createElement("script");n.src="".concat(at).concat(t);var o=document.head||document.body;if(!o)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return o.appendChild(n),n},dt=function(e,t){!e||!e._registerWrapper||e._registerWrapper({name:"stripe-js",version:"7.9.0",startTime:t})},ne=null,pe=null,ue=null,pt=function(e){return function(t){e(new Error("Failed to load Stripe.js",{cause:t}))}},ut=function(e,t){return function(){window.Stripe?e(window.Stripe):t(new Error("Stripe.js not available"))}},gt=function(e){return ne!==null?ne:(ne=new Promise(function(t,n){if(typeof window>"u"||typeof document>"u"){t(null);return}if(window.Stripe&&e&&console.warn(ze),window.Stripe){t(window.Stripe);return}try{var o=ct();if(o&&e)console.warn(ze);else if(!o)o=We(e);else if(o&&ue!==null&&pe!==null){var c;o.removeEventListener("load",ue),o.removeEventListener("error",pe),(c=o.parentNode)===null||c===void 0||c.removeChild(o),o=We(e)}ue=ut(t,n),pe=pt(n),o.addEventListener("load",ue),o.addEventListener("error",pe)}catch(b){n(b);return}}),ne.catch(function(t){return ne=null,Promise.reject(t)}))},ft=function(e,t,n){if(e===null)return null;var o=t[0],c=o.match(/^pk_test/),b=rt(e.version),u=Qe;c&&b!==u&&console.warn("Stripe.js@".concat(b," was loaded on the page, but @stripe/stripe-js@").concat("7.9.0"," expected Stripe.js@").concat(u,". This may result in unexpected behavior. For more information, see https://docs.stripe.com/sdks/stripejs-versioning"));var Me=e.apply(void 0,t);return dt(Me,n),Me},ie,Xe=!1,He=function(){return ie||(ie=gt(null).catch(function(e){return ie=null,Promise.reject(e)}),ie)};Promise.resolve().then(function(){return He()}).catch(function(r){Xe||console.warn(r)});var Ke=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Xe=!0;var o=Date.now();return He().then(function(c){return ft(c,t,o)})};var ge=class r{stripePromise;stripe=null;constructor(){this.stripePromise=Ke(qe.stripe.publishableKey)}getStripe(){return m(this,null,function*(){return this.stripe||(this.stripe=yield this.stripePromise),this.stripe})}createElement(e){return m(this,null,function*(){let t=yield this.getStripe();if(!t)throw new Error("Stripe failed to load");let n=t.elements({clientSecret:e,appearance:{theme:"stripe",variables:{colorPrimary:"#3b82f6",colorBackground:"#ffffff",colorText:"#1f2937",colorDanger:"#ef4444",fontFamily:'"Inter", "Segoe UI", sans-serif',spacingUnit:"4px",borderRadius:"8px"},rules:{".Tab":{border:"1px solid #e5e7eb",boxShadow:"0 1px 3px 0 rgba(0, 0, 0, 0.1)"},".Tab:hover":{color:"#1f2937",backgroundColor:"#f9fafb"},".Tab--selected":{backgroundColor:"#3b82f6",color:"#ffffff"}}}}),o=n.create("payment",{layout:"tabs"});return{elements:n,paymentElement:o}})}confirmPayment(e,t,n){return m(this,null,function*(){let o=yield this.getStripe();if(!o)throw new Error("Stripe failed to load");return yield o.confirmPayment({elements:t,confirmParams:{return_url:n}})})}confirmPaymentWithoutRedirect(e,t){return m(this,null,function*(){let n=yield this.getStripe();if(!n)throw new Error("Stripe failed to load");let{error:o}=yield t.submit();if(o)throw o;return yield n.confirmPayment({elements:t,confirmParams:{},redirect:"if_required"})})}retrievePaymentIntent(e){return m(this,null,function*(){let t=yield this.getStripe();if(!t)throw new Error("Stripe failed to load");return yield t.retrievePaymentIntent(e)})}static \u0275fac=function(t){return new(t||r)};static \u0275prov=oe({token:r,factory:r.\u0275fac,providedIn:"root"})};var ht=["stripeElements"];function _t(r,e){r&1&&(a(0,"mat-error"),s(1," Please select a payment method "),i())}function vt(r,e){if(r&1&&(a(0,"form",9)(1,"mat-form-field",15)(2,"mat-label"),s(3,"Payment Method"),i(),a(4,"mat-select",16)(5,"mat-option",17),s(6,"Credit/Debit Card"),i()(),E(7,_t,2,0,"mat-error",18),i(),a(8,"div",19)(9,"mat-icon"),s(10,"info"),i(),a(11,"p"),s(12,"This payment will be processed securely via Stripe."),i()()()),r&2){let t,n=f();d("formGroup",n.paymentForm),l(7),d("ngIf",(t=n.paymentForm.get("paymentMethod"))==null?null:t.hasError("required"))}}function bt(r,e){if(r&1&&(a(0,"div",21)(1,"mat-icon"),s(2,"error"),i(),a(3,"span"),s(4),i()()),r&2){let t=f(2);l(4),he(t.stripeError())}}function Ct(r,e){if(r&1&&(a(0,"div",10),h(1,"div",20,0),C(3,bt,5,1,"div",21),i()),r&2){let t=f();l(3),x(t.stripeError()?3:-1)}}function xt(r,e){r&1&&(a(0,"div",11),h(1,"mat-spinner",22),a(2,"p"),s(3,"Processing payment..."),i()())}function Mt(r,e){if(r&1){let t=W();a(0,"button",23),_("click",function(){M(t);let o=f();return P(o.setupStripePayment())}),a(1,"mat-icon"),s(2,"credit_card"),i(),s(3," Proceed to Payment "),i()}if(r&2){let t=f();d("disabled",t.paymentForm.invalid||t.processing())}}function Pt(r,e){if(r&1){let t=W();a(0,"button",23),_("click",function(){M(t);let o=f();return P(o.processPayment())}),a(1,"mat-icon"),s(2,"lock"),i(),s(3," Complete Payment "),i()}if(r&2){let t=f();d("disabled",t.processing())}}var Ye=class r{constructor(e){this.data=e;this.paymentForm=this.formBuilder.group({paymentMethod:["card",[y.required]]})}stripeElementsRef;dialogRef=p(B);formBuilder=p(N);stripeService=p(ge);chatService=p(de);projectService=p(Ve);cdr=p(De);paymentForm;showStripeForm=S(!1);processing=S(!1);stripeError=S(null);elements=null;paymentElement=null;clientSecret=null;ngOnInit(){}ngAfterViewInit(){}setupStripePayment(){return m(this,null,function*(){if(!this.paymentForm.invalid){this.processing.set(!0),this.stripeError.set(null);try{let e;if((this.data.isProjectPayment||this.data.isInitialPayment)&&this.data.projectId)console.log("Creating project payment intent for project:",this.data.projectId),e=yield this.projectService.createProjectPaymentIntentAsync(this.data.projectId),console.log("Project payment intent created:",e);else if(this.data.chatId&&this.data.messageId)console.log("Creating additional payment intent for chat:",this.data.chatId,"message:",this.data.messageId),e=yield this.chatService.createAdditionalPaymentIntentAsync(this.data.chatId,this.data.messageId),console.log("Additional payment intent created:",e);else throw new Error("Missing required payment data");this.clientSecret=e.clientSecret;let{elements:t,paymentElement:n}=yield this.stripeService.createElement(this.clientSecret);this.elements=t,this.paymentElement=n,this.showStripeForm.set(!0),this.cdr.detectChanges(),setTimeout(()=>{this.stripeElementsRef?.nativeElement?this.paymentElement.mount(this.stripeElementsRef.nativeElement):this.stripeError.set("Unable to initialize payment form")},100)}catch(e){console.error("Error setting up payment:",e),this.stripeError.set(e.message||"Failed to setup payment")}finally{this.processing.set(!1)}}})}processPayment(){return m(this,null,function*(){if(!this.elements||!this.clientSecret){this.stripeError.set("Payment not properly initialized");return}this.processing.set(!0),this.stripeError.set(null);try{let e=yield this.stripeService.retrievePaymentIntent(this.clientSecret);console.log("Current payment intent status:",e.paymentIntent?.status);let t;if(e.paymentIntent?.status==="succeeded")console.log("Payment already succeeded, skipping confirmation"),t=e.paymentIntent;else{console.log("Attempting to confirm payment intent");let{error:n,paymentIntent:o}=yield this.stripeService.confirmPaymentWithoutRedirect(this.clientSecret,this.elements);if(n){console.error("Stripe payment confirmation error:",n),console.error("Error details:",{type:n.type,code:n.code,decline_code:n.decline_code,message:n.message,payment_intent:n.payment_intent}),this.stripeError.set(n.message||"Payment failed");return}t=o}if(t?.status==="succeeded"){console.log("Stripe payment succeeded:",t.id),console.log("Payment type:",this.data.isProjectPayment||this.data.isInitialPayment?"project":"additional");try{if((this.data.isProjectPayment||this.data.isInitialPayment)&&this.data.projectId){console.log("\u{1F50D} Confirming project payment for project:",this.data.projectId),console.log("\u{1F4DD} Payment modal data:",{isInitialPayment:this.data.isInitialPayment,isProjectPayment:this.data.isProjectPayment,messageId:this.data.messageId,chatId:this.data.chatId,projectId:this.data.projectId});let o=this.data.isInitialPayment?this.data.messageId:void 0,c=this.data.isInitialPayment?this.data.chatId:void 0;console.log("\u{1F4E4} Passing to backend:",{messageIdToPass:o,chatIdToPass:c}),yield this.projectService.confirmProjectPaymentAsync(this.data.projectId,t.id,o,c),console.log("\u2705 Project payment confirmed successfully")}else if(this.data.chatId&&this.data.messageId){console.log("Confirming additional payment for chat:",this.data.chatId,"message:",this.data.messageId);let o=yield this.chatService.confirmAdditionalPaymentAsync(this.data.chatId,this.data.messageId,t.id);console.log("Additional payment confirmed successfully, result:",o)}}catch(o){if(console.error("Backend confirmation error:",o),o?.message?.includes("already processed")||o?.message?.includes("already completed")||o?.status===409)console.log("Payment was already processed, continuing with success flow");else throw o}let n={amount:this.data.amount,description:this.data.description,paymentMethod:this.paymentForm.value.paymentMethod,paymentIntentId:t.id};this.dialogRef.close(n)}else this.stripeError.set("Payment was not completed successfully")}catch(e){console.error("Error processing payment:",e),this.stripeError.set(e.message||"Payment processing failed")}finally{this.processing.set(!1)}})}onCancel(){this.dialogRef.close()}static \u0275fac=function(t){return new(t||r)(re(K))};static \u0275cmp=w({type:r,selectors:[["app-payment-modal"]],viewQuery:function(t,n){if(t&1&&Ee(ht,5,Pe),t&2){let o;Ie(o=Re())&&(n.stripeElementsRef=o.first)}},decls:26,vars:7,consts:[["stripeElements",""],["mat-dialog-title","",1,"dialog-title"],[1,"title-icon"],["mat-dialog-content","",1,"dialog-content"],[1,"payment-details"],[1,"amount-section"],[1,"amount-display"],[1,"description-section"],[1,"business-name"],[1,"payment-form",3,"formGroup"],[1,"stripe-form"],[1,"loading-overlay"],["mat-dialog-actions","","align","end"],["mat-button","",3,"click","disabled"],["mat-raised-button","","color","primary",3,"disabled"],["appearance","outline",1,"full-width"],["formControlName","paymentMethod"],["value","card"],[4,"ngIf"],[1,"payment-note"],[1,"stripe-elements"],[1,"error-message"],["diameter","40"],["mat-raised-button","","color","primary",3,"click","disabled"]],template:function(t,n){t&1&&(a(0,"h1",1)(1,"mat-icon",2),s(2,"payment"),i(),s(3," Make Payment "),i(),a(4,"div",3)(5,"div",4)(6,"div",5)(7,"h3"),s(8,"Payment Amount"),i(),a(9,"div",6),s(10),i()(),a(11,"div",7)(12,"h3"),s(13,"Payment For"),i(),a(14,"p"),s(15),i(),a(16,"p",8),s(17),i()()(),C(18,vt,13,2,"form",9)(19,Ct,4,1,"div",10),C(20,xt,4,0,"div",11),i(),a(21,"div",12)(22,"button",13),_("click",function(){return n.onCancel()}),s(23," Cancel "),i(),C(24,Mt,4,1,"button",14)(25,Pt,4,1,"button",14),i()),t&2&&(l(10),v(" $",n.data.amount," "),l(5),he(n.data.description),l(2),v("To: ",n.data.businessName),l(),x(n.showStripeForm()?19:18),l(2),x(n.processing()?20:-1),l(2),d("disabled",n.processing()),l(2),x(n.showStripeForm()?25:24))},dependencies:[I,Q,$,T,O,q,A,k,z,Y,ee,Z,D,j,G,U,V,X,L,F,R,le,se,ae,ce,me],styles:[".dialog-title[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;font-size:20px;font-weight:600;margin-bottom:0}.title-icon[_ngcontent-%COMP%]{color:#10b981;font-size:24px}.dialog-content[_ngcontent-%COMP%]{min-width:400px;max-width:500px}.payment-details[_ngcontent-%COMP%]{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:20px;margin-bottom:20px}.amount-section[_ngcontent-%COMP%]{text-align:center;margin-bottom:16px}.amount-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:14px;font-weight:600;color:#64748b;margin:0 0 8px;text-transform:uppercase;letter-spacing:.5px}.amount-display[_ngcontent-%COMP%]{font-size:32px;font-weight:700;color:#10b981;margin-bottom:16px}.description-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:14px;font-weight:600;color:#64748b;margin:0 0 8px;text-transform:uppercase;letter-spacing:.5px}.description-section[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0 0 8px;color:#374151;line-height:1.5}.business-name[_ngcontent-%COMP%]{font-weight:600;color:#1f2937}.payment-form[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:16px}.full-width[_ngcontent-%COMP%]{width:100%}.payment-note[_ngcontent-%COMP%]{display:flex;align-items:flex-start;gap:8px;padding:12px;background:#dbeafe;border:1px solid #bfdbfe;border-radius:8px;margin-top:16px}.payment-note[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{color:#3b82f6;font-size:20px;margin-top:2px}.payment-note[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;font-size:14px;color:#1e40af;line-height:1.4}mat-dialog-actions[_ngcontent-%COMP%]{padding-top:16px}mat-dialog-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{margin-left:8px}mat-dialog-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{margin-right:8px;font-size:18px}.stripe-form[_ngcontent-%COMP%]{margin:20px 0}.stripe-elements[_ngcontent-%COMP%]{border:1px solid #e2e8f0;border-radius:8px;padding:16px;background:#fff}.error-message[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;color:#ef4444;margin-top:12px;font-size:14px}.error-message[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:18px}.loading-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;background:#ffffffe6;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;border-radius:12px}.loading-overlay[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;font-weight:500;color:#64748b}"]})};function St(r,e){r&1&&(a(0,"mat-error"),s(1," Amount is required "),i())}function wt(r,e){r&1&&(a(0,"mat-error"),s(1," Amount must be greater than 0 "),i())}function Et(r,e){r&1&&(a(0,"mat-error"),s(1," Description is required "),i())}function It(r,e){r&1&&(a(0,"mat-error"),s(1," Message is required "),i())}var tt=class r{constructor(e){this.data=e;let t=this.data?.defaultAmount||"",n=this.data?.isStartPayment||!1,o=n?"Project payment":"",c=n?"Payment is required to start working on your project. This amount covers the agreed services and deliverables.":"";this.paymentForm=this.formBuilder.group({amount:[t,[y.required,y.min(.01)]],description:[o,[y.required,y.minLength(3)]],content:[c,[y.required,y.minLength(10)]]})}dialogRef=p(B);formBuilder=p(N);paymentForm;onCancel(){this.dialogRef.close()}onSubmit(){if(this.paymentForm.valid){let e=this.paymentForm.value,t={amount:parseFloat(e.amount),description:e.description,content:e.content};this.dialogRef.close(t)}}static \u0275fac=function(t){return new(t||r)(re(K))};static \u0275cmp=w({type:r,selectors:[["app-payment-request-modal"]],decls:29,vars:10,consts:[["mat-dialog-title","",1,"dialog-title"],[1,"title-icon"],["mat-dialog-content","",1,"dialog-content"],[1,"payment-form",3,"formGroup"],["appearance","outline",1,"full-width"],["matInput","","type","number","formControlName","amount","placeholder","0.00","min","0.01","step","0.01"],[4,"ngIf"],["matInput","","formControlName","description",3,"placeholder"],["matInput","","formControlName","content","rows","4",3,"placeholder"],["mat-dialog-actions","","align","end"],["mat-button","",3,"click"],["mat-raised-button","","color","primary",3,"click","disabled"]],template:function(t,n){if(t&1&&(a(0,"h1",0)(1,"mat-icon",1),s(2,"payment"),i(),s(3),i(),a(4,"div",2)(5,"form",3)(6,"mat-form-field",4)(7,"mat-label"),s(8,"Amount ($)"),i(),h(9,"input",5),E(10,St,2,0,"mat-error",6)(11,wt,2,0,"mat-error",6),i(),a(12,"mat-form-field",4)(13,"mat-label"),s(14,"Description"),i(),h(15,"input",7),E(16,Et,2,0,"mat-error",6),i(),a(17,"mat-form-field",4)(18,"mat-label"),s(19,"Message to Client"),i(),h(20,"textarea",8),E(21,It,2,0,"mat-error",6),i()()(),a(22,"div",9)(23,"button",10),_("click",function(){return n.onCancel()}),s(24," Cancel "),i(),a(25,"button",11),_("click",function(){return n.onSubmit()}),a(26,"mat-icon"),s(27,"send"),i(),s(28),i()()),t&2){let o,c,b,u;l(3),v(" ",n.data!=null&&n.data.isStartPayment?"Request Project Payment":"Request Additional Payment"," "),l(2),d("formGroup",n.paymentForm),l(5),d("ngIf",(o=n.paymentForm.get("amount"))==null?null:o.hasError("required")),l(),d("ngIf",(c=n.paymentForm.get("amount"))==null?null:c.hasError("min")),l(4),d("placeholder",n.data!=null&&n.data.isStartPayment?"Payment for project services":"Why is additional payment needed?"),l(),d("ngIf",(b=n.paymentForm.get("description"))==null?null:b.hasError("required")),l(4),d("placeholder",n.data!=null&&n.data.isStartPayment?"Message about project payment and start...":"Explain the payment request in detail..."),l(),d("ngIf",(u=n.paymentForm.get("content"))==null?null:u.hasError("required")),l(4),d("disabled",n.paymentForm.invalid),l(3),v(" ",n.data!=null&&n.data.isStartPayment?"Start Project & Request Payment":"Send Payment Request"," ")}},dependencies:[I,Q,$,T,J,Ae,O,q,ke,A,k,z,Y,ee,Z,D,j,G,U,V,X,L,H,F,R],styles:[".dialog-title[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;font-size:20px;font-weight:600;margin-bottom:0}.title-icon[_ngcontent-%COMP%]{color:#3b82f6;font-size:24px}.dialog-content[_ngcontent-%COMP%]{min-width:400px;max-width:500px}.payment-form[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:16px;margin-top:16px}.full-width[_ngcontent-%COMP%]{width:100%}mat-dialog-actions[_ngcontent-%COMP%]{padding-top:16px}mat-dialog-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{margin-left:8px}mat-dialog-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{margin-right:8px;font-size:18px}"]})};function Rt(r,e){r&1&&(a(0,"mat-error"),s(1," Completion details are required "),i())}function Ft(r,e){r&1&&(a(0,"mat-error"),s(1," Please provide more detailed information (at least 20 characters) "),i())}var it=class r{dialogRef=p(B);formBuilder=p(N);completionForm;constructor(){this.completionForm=this.formBuilder.group({content:["Project has been completed and is ready for review.",[y.required,y.minLength(20)]]})}onCancel(){this.dialogRef.close()}onSubmit(){if(this.completionForm.valid){let e={content:this.completionForm.value.content};this.dialogRef.close(e)}}static \u0275fac=function(t){return new(t||r)};static \u0275cmp=w({type:r,selectors:[["app-completion-request-modal"]],decls:23,vars:4,consts:[["mat-dialog-title","",1,"dialog-title"],[1,"title-icon"],["mat-dialog-content","",1,"dialog-content"],[1,"description"],[1,"completion-form",3,"formGroup"],["appearance","outline",1,"full-width"],["matInput","","formControlName","content","rows","6","placeholder","Describe what has been completed, delivered, or achieved..."],[4,"ngIf"],["mat-dialog-actions","","align","end"],["mat-button","",3,"click"],["mat-raised-button","","color","primary",3,"click","disabled"]],template:function(t,n){if(t&1&&(a(0,"h1",0)(1,"mat-icon",1),s(2,"check_circle"),i(),s(3," Request Project Completion "),i(),a(4,"div",2)(5,"p",3),s(6," You're about to request client approval for project completion. Please describe what has been completed and delivered. "),i(),a(7,"form",4)(8,"mat-form-field",5)(9,"mat-label"),s(10,"Completion Details"),i(),h(11,"textarea",6),a(12,"mat-hint"),s(13,"Be specific about deliverables and outcomes"),i(),E(14,Rt,2,0,"mat-error",7)(15,Ft,2,0,"mat-error",7),i()()(),a(16,"div",8)(17,"button",9),_("click",function(){return n.onCancel()}),s(18," Cancel "),i(),a(19,"button",10),_("click",function(){return n.onSubmit()}),a(20,"mat-icon"),s(21,"send"),i(),s(22," Request Completion Approval "),i()()),t&2){let o,c;l(7),d("formGroup",n.completionForm),l(7),d("ngIf",(o=n.completionForm.get("content"))==null?null:o.hasError("required")),l(),d("ngIf",(c=n.completionForm.get("content"))==null?null:c.hasError("minlength")),l(4),d("disabled",n.completionForm.invalid)}},dependencies:[I,Q,$,T,J,O,q,A,k,z,Y,ee,Z,D,j,G,U,V,$e,X,L,H,F,R],styles:[".dialog-title[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;font-size:20px;font-weight:600;margin-bottom:0}.title-icon[_ngcontent-%COMP%]{color:#10b981;font-size:24px}.dialog-content[_ngcontent-%COMP%]{min-width:400px;max-width:500px}.description[_ngcontent-%COMP%]{color:#64748b;font-size:14px;line-height:1.5;margin:0 0 16px;padding:12px;background:#f8fafc;border-radius:8px;border-left:4px solid #10b981}.completion-form[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:16px}.full-width[_ngcontent-%COMP%]{width:100%}mat-dialog-actions[_ngcontent-%COMP%]{padding-top:16px}mat-dialog-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{margin-left:8px}mat-dialog-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{margin-right:8px;font-size:18px}"]})};var jt=()=>[1,2,3,4,5],Dt=(r,e)=>e._id;function Ot(r,e){r&1&&(a(0,"div",2),h(1,"mat-spinner",5),a(2,"span",6),s(3,"Loading projects..."),i()())}function qt(r,e){if(r&1){let t=W();a(0,"div",3)(1,"mat-icon",7),s(2,"work_off"),i(),a(3,"h3",8),s(4,"No Completed Projects"),i(),a(5,"p",9),s(6,"You need to complete a project with this business before you can leave a review."),i(),a(7,"button",10),_("click",function(){M(t);let o=f();return P(o.dialogRef.close())}),s(8," Close "),i()()}}function Tt(r,e){if(r&1&&(a(0,"span",32),s(1),i()),r&2){let t=f().$implicit,n=f(2);l(),v(" - Completed ",n.formatDate(t.completed_at))}}function At(r,e){if(r&1&&(a(0,"mat-option",14),s(1),C(2,Tt,2,1,"span",32),i()),r&2){let t=e.$implicit;d("value",t._id),l(),v(" ",t.title," "),l(),x(t.completed_at?2:-1)}}function kt(r,e){if(r&1){let t=W();a(0,"mat-icon",33),_("click",function(){let o=M(t).$implicit,c=f(2);return P(c.setRating(o))}),s(1," star "),i()}if(r&2){let t,n,o=e.$implicit,c=f(2);Fe("text-yellow-400",o<=((t=c.reviewForm.get("rating"))==null?null:t.value))("text-gray-300",o>((n=c.reviewForm.get("rating"))==null?null:n.value))}}function Nt(r,e){r&1&&h(0,"mat-spinner",31)}function $t(r,e){if(r&1){let t=W();a(0,"form",11),_("ngSubmit",function(){M(t);let o=f();return P(o.submitReview())}),a(1,"mat-form-field",12)(2,"mat-label"),s(3,"Select Project"),i(),a(4,"mat-select",13),fe(5,At,3,3,"mat-option",14,Dt),i()(),a(7,"div",15)(8,"label",16),s(9,"Overall Rating *"),i(),a(10,"div",17),fe(11,kt,2,4,"mat-icon",18,we),a(13,"span",19),s(14),i()()(),a(15,"mat-form-field",12)(16,"mat-label"),s(17,"Review"),i(),a(18,"textarea",20),s(19,"            "),i()(),a(20,"div",21)(21,"div")(22,"label",16),s(23,"Service Quality"),i(),a(24,"mat-slider",22),h(25,"input",23),i(),a(26,"div",24),s(27),i()(),a(28,"div")(29,"label",16),s(30,"Communication"),i(),a(31,"mat-slider",22),h(32,"input",25),i(),a(33,"div",24),s(34),i()(),a(35,"div")(36,"label",16),s(37,"Timeliness"),i(),a(38,"mat-slider",22),h(39,"input",26),i(),a(40,"div",24),s(41),i()(),a(42,"div")(43,"label",16),s(44,"Value for Money"),i(),a(45,"mat-slider",22),h(46,"input",27),i(),a(47,"div",24),s(48),i()()(),a(49,"div",28)(50,"button",29),_("click",function(){M(t);let o=f();return P(o.dialogRef.close())}),s(51," Cancel "),i(),a(52,"button",30),C(53,Nt,1,0,"mat-spinner",31),s(54," Submit Review "),i()()()}if(r&2){let t,n,o,c,b,u=f();d("formGroup",u.reviewForm),l(5),ye(u.completedProjects()),l(6),ye(je(12,jt)),l(3),v("",((t=u.reviewForm.get("rating"))==null?null:t.value)||0,"/5"),l(10),d("displayWith",u.formatSliderLabel),l(3),v("",((n=u.reviewForm.get("service_quality"))==null?null:n.value)||0,"/5"),l(4),d("displayWith",u.formatSliderLabel),l(3),v("",((o=u.reviewForm.get("communication"))==null?null:o.value)||0,"/5"),l(4),d("displayWith",u.formatSliderLabel),l(3),v("",((c=u.reviewForm.get("timeliness"))==null?null:c.value)||0,"/5"),l(4),d("displayWith",u.formatSliderLabel),l(3),v("",((b=u.reviewForm.get("value_for_money"))==null?null:b.value)||0,"/5"),l(4),d("disabled",!u.reviewForm.valid||u.submitting()),l(),x(u.submitting()?53:-1)}}var ot=class r{reviewSubmitted=new Se;fb=p(N);reviewService=p(Be);dialogRef=p(B);data=p(K,{optional:!0});completedProjects=S([]);submitting=S(!1);loadingProjects=S(!1);get businessId(){return this.data?.businessId||""}get businessName(){return this.data?.businessName||"Business"}get projectId(){return this.data?.projectId||null}get projectTitle(){return this.data?.projectTitle||"Current Project"}reviewForm;constructor(){this.reviewForm=this.fb.group({project_id:["",y.required],rating:[0,[y.required,y.min(1),y.max(5)]],review_text:[""],service_quality:[5],communication:[5],timeliness:[5],value_for_money:[5]})}ngOnInit(){this.projectId?(this.reviewForm.patchValue({project_id:this.projectId}),this.completedProjects.set([{_id:this.projectId,title:this.projectTitle,business_id:{_id:this.businessId,name:this.businessName},completed_at:new Date,client_id:"",business_owner_id:"",status:"completed"}])):this.loadCompletedProjects()}loadCompletedProjects(){return m(this,null,function*(){try{this.loadingProjects.set(!0);let t=(yield this.reviewService.getCompletedProjectsForReviewAsync()).filter(n=>n.business_id._id===this.businessId);this.completedProjects.set(t)}catch(e){console.error("Error loading completed projects:",e)}finally{this.loadingProjects.set(!1)}})}setRating(e){this.reviewForm.patchValue({rating:e})}formatSliderLabel(e){return`${e}`}formatDate(e){return e?new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"Date not specified"}submitReview(){return m(this,null,function*(){if(!this.reviewForm.invalid)try{this.submitting.set(!0);let e=this.reviewForm.value,t={project_id:e.project_id,rating:e.rating,review_text:e.review_text||void 0,service_quality:e.service_quality,communication:e.communication,timeliness:e.timeliness,value_for_money:e.value_for_money};yield this.reviewService.createReviewAsync(t),this.reviewSubmitted.emit(),this.dialogRef.close(!0)}catch(e){console.error("Error submitting review:",e)}finally{this.submitting.set(!1)}})}static \u0275fac=function(t){return new(t||r)};static \u0275cmp=w({type:r,selectors:[["app-review-form"]],outputs:{reviewSubmitted:"reviewSubmitted"},decls:6,vars:1,consts:[[1,"p-6"],[1,"text-xl","font-semibold","text-gray-900","mb-4"],[1,"flex","items-center","justify-center","py-8"],[1,"text-center","py-8"],[3,"formGroup"],["diameter","40"],[1,"ml-3","text-gray-600"],[1,"text-gray-400","text-6xl","mb-4"],[1,"text-lg","font-medium","text-gray-900","mb-2"],[1,"text-gray-600","mb-4"],["mat-button","","color","primary",3,"click"],[3,"ngSubmit","formGroup"],["appearance","outline",1,"w-full","mb-4"],["formControlName","project_id","required",""],[3,"value"],[1,"mb-4"],[1,"block","text-sm","font-medium","text-gray-700","mb-2"],[1,"flex","items-center","space-x-2"],[1,"cursor-pointer","text-2xl","hover:text-yellow-400","transition-colors",3,"text-yellow-400","text-gray-300"],[1,"ml-2","text-sm","text-gray-600"],["matInput","","formControlName","review_text","rows","4","placeholder","Share your experience working with this business..."],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4","mb-6"],["min","1","max","5","step","1","discrete","",3,"displayWith"],["matSliderThumb","","formControlName","service_quality"],[1,"text-xs","text-gray-500","mt-1"],["matSliderThumb","","formControlName","communication"],["matSliderThumb","","formControlName","timeliness"],["matSliderThumb","","formControlName","value_for_money"],[1,"flex","justify-end","space-x-3"],["type","button","mat-button","",3,"click"],["type","submit","mat-raised-button","","color","primary",3,"disabled"],["diameter","20",1,"mr-2"],[1,"text-sm","text-gray-500"],[1,"cursor-pointer","text-2xl","hover:text-yellow-400","transition-colors",3,"click"]],template:function(t,n){t&1&&(a(0,"div",0)(1,"h2",1),s(2,"Leave a Review"),i(),C(3,Ot,4,0,"div",2)(4,qt,9,0,"div",3)(5,$t,55,13,"form",4),i()),t&2&&(l(3),x(n.loadingProjects()?3:n.completedProjects().length===0?4:5))},dependencies:[I,$,T,J,O,q,Ne,A,k,z,G,U,V,L,H,D,j,le,se,ae,F,R,Le,Ue,Ge,ce,me],styles:["[_nghost-%COMP%]{display:block;max-width:600px}.mat-mdc-slider[_ngcontent-%COMP%]{width:100%}mat-icon.text-yellow-400[_ngcontent-%COMP%]{color:#fbbf24}mat-icon.text-gray-300[_ngcontent-%COMP%]{color:#d1d5db}"]})};export{de as a,Ye as b,tt as c,it as d,ot as e};
