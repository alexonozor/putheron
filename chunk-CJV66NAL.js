import{a as l}from"./chunk-C3KG2QNL.js";import{g}from"./chunk-HNHRL3LT.js";import{C as b,E as p,I as A,W as R,ba as u,ga as c,l as n,q as f,r as S}from"./chunk-VCYZZ2B3.js";import{a as m,b as d}from"./chunk-JKOY2XUY.js";var h=class a{authService=c(l);router=c(g);canActivate(r,s){return this.checkPermissions(r,s)}canActivateChild(r,s){return this.checkPermissions(r,s)}checkPermissions(r,s){let e=r.data;return console.log("Permission Guard Check:",{route:s.url,guardData:e,hasPermissions:!!e.permissions,hasRoles:!!e.roles}),!e.permissions&&!e.roles?(console.log("No permission requirements, allowing access"),n(!0)):this.authService.userPermissions$.pipe(R(i=>{if(console.log("User permissions in guard:",i),i)return n(i);let t=this.authService.isLoading();return console.log("Permissions not loaded, isLoading:",t),t?this.authService.userPermissions$.pipe(b(o=>o!==null),f(5e3),A(1),p(o=>(console.error("Timeout waiting for permissions to load:",o),n(null)))):n(null)}),S(i=>{if(console.log("Final permission check with:",i),!i)return console.log("No user permissions available, denying access"),this.handleUnauthorizedAccess(e,s.url),!1;let t=!1,o=!1;e.permissions&&(t=this.checkUserPermissions(e.permissions,e.requireAll||!1),console.log("Permission check result:",{requiredPermissions:e.permissions,hasPermissions:t,requireAll:e.requireAll})),e.roles&&(o=this.checkUserRoles(e.roles,e.requireAll||!1),console.log("Role check result:",{requiredRoles:e.roles,hasRoles:o,requireAll:e.requireAll}));let v=e.permissions&&e.roles?t||o:e.permissions?t:o;return console.log("Final access check:",{hasPermissions:t,hasRoles:o,hasAccess:v,bothSpecified:!!(e.permissions&&e.roles)}),v?(console.log("Permission check passed, allowing access"),!0):(this.handleUnauthorizedAccess(e,s.url),!1)}),p(i=>(console.error("Permission check error:",i),this.handleUnauthorizedAccess(e,s.url),n(!1))))}checkUserPermissions(r,s){let e=Array.isArray(r)?r:[r],i;s?i=this.authService.hasAllPermissions(e):i=this.authService.hasAnyPermission(e);let t=this.authService.permissionNames();return console.log("Permission check details:",{requiredPermissions:e,requireAll:s,userPermissions:t,result:i,matchingPermissions:e.filter(o=>t.includes(o))}),i}checkUserRoles(r,s){let e=Array.isArray(r)?r:[r],i;s?i=e.every(o=>this.authService.hasRole(o)):i=this.authService.hasAnyRole(e);let t=this.authService.activeRoles().map(o=>o.name);return console.log("Role check details:",{requiredRoles:e,requireAll:s,userRoles:t,result:i,matchingRoles:e.filter(o=>t.includes(o))}),i}handleUnauthorizedAccess(r,s){let e=r.redirectTo||"/unauthorized";console.warn("Unauthorized access attempt:",{requestedUrl:s,requiredPermissions:r.permissions,requiredRoles:r.roles,userPermissions:this.authService.permissionNames(),userRoles:this.authService.activeRoles().map(i=>i.name),redirectTo:e,reason:"User does not have required permissions or roles"}),sessionStorage.setItem("redirectUrl",s),this.router.navigate([e],{queryParams:{returnUrl:s,reason:"insufficient_permissions"}})}static \u0275fac=function(s){return new(s||a)};static \u0275prov=u({token:a,factory:a.\u0275fac,providedIn:"root"})},P=class a{permissionGuard=c(h);canActivate(r,s){let e=Object.create(r);return e.data=d(m({},r.data),{permissions:[l.PERMISSIONS.ADMIN_ACCESS],redirectTo:"/dashboard"}),this.permissionGuard.canActivate(e,s)}static \u0275fac=function(s){return new(s||a)};static \u0275prov=u({token:a,factory:a.\u0275fac,providedIn:"root"})},y=class a{permissionGuard=c(h);canActivate(r,s){let e=Object.create(r);return e.data=d(m({},r.data),{permissions:[l.PERMISSIONS.ROLES_VIEW,l.PERMISSIONS.USERS_VIEW],requireAll:!1,redirectTo:"/dashboard"}),this.permissionGuard.canActivate(e,s)}static \u0275fac=function(s){return new(s||a)};static \u0275prov=u({token:a,factory:a.\u0275fac,providedIn:"root"})};export{h as a,P as b,y as c};
